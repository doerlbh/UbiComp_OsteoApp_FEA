\documentclass{sigchi}

% Use this command to override the default ACM copyright statement
% (e.g. for preprints).  Consult the conference website for the
% camera-ready copyright statement.

%% EXAMPLE BEGIN -- HOW TO OVERRIDE THE DEFAULT COPYRIGHT STRIP -- (July 22, 2013 - Paul Baumann)
% \toappear{Permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page. Copyrights for components of this work owned by others than ACM must be honored. Abstracting with credit is permitted. To copy otherwise, or republish, to post on servers or to redistribute to lists, requires prior specific permission and/or a fee. Request permissions from permissions@acm.org. \\
% {\emph{CHI'14}}, April 26--May 1, 2014, Toronto, Canada. \\
% Copyright \copyright~2014 ACM ISBN/14/04...\$15.00. \\
% DOI string from ACM form confirmation}
%% EXAMPLE END -- HOW TO OVERRIDE THE DEFAULT COPYRIGHT STRIP -- (July 22, 2013 - Paul Baumann)

% Arabic page numbers for submission.  Remove this line to eliminate
% page numbers for the camera ready copy
% \pagenumbering{arabic}

% Load basic packages
\usepackage{balance}  % to better equalize the last page
\usepackage{graphics} % for EPS, load graphicx instead 
\usepackage[T1]{fontenc}
\usepackage{txfonts}
\usepackage{mathptmx}
\usepackage[pdftex]{hyperref}
\usepackage{color}
\usepackage{booktabs}
\usepackage{textcomp}
% Some optional stuff you might like/need.
\usepackage{microtype} % Improved Tracking and Kerning
% \usepackage[all]{hypcap}  % Fixes bug in hyperref caption linking
\usepackage{ccicons}  % Cite your images correctly!
% \usepackage[utf8]{inputenc} % for a UTF8 editor only

\usepackage{chemformula}
\usepackage{booktabs,amsmath}
\usepackage[utf8]{inputenc}
\usepackage{array}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{placeins}
\usepackage{float}
\usepackage{amssymb}
\usepackage{pdfpages}
\usepackage{chemformula}
\usepackage{amsmath}
\usepackage{caption}
\usepackage{subcaption}
%\usepackage{subfig}

% If you want to use todo notes, marginpars etc. during creation of your draft document, you
% have to enable the "chi_draft" option for the document class. To do this, change the very first
% line to: "\documentclass[chi_draft]{sigchi}". You can then place todo notes by using the "\todo{...}"
% command. Make sure to disable the draft option again before submitting your final document.
\usepackage{todonotes}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

% Paper metadata (use plain text, for PDF inclusion and later
% re-using, if desired).  Use \emtpyauthor when submitting for review
% so you remain anonymous.
\def\plaintitle{SIGCHI Conference Proceedings Format}
\def\plainauthor{First Author, Second Author, Third Author,
  Fourth Author, Fifth Author, Sixth Author}
\def\emptyauthor{}
\def\plainkeywords{Authors' choice; of terms; separated; by
  semicolons; include commas, within terms only; required.}
\def\plaingeneralterms{Documentation, Standardization}

% llt: Define a global style for URLs, rather that the default one
\makeatletter
\def\url@leostyle{%
  \@ifundefined{selectfont}{
    \def\UrlFont{\sf}
  }{
    \def\UrlFont{\small\bf\ttfamily}
  }}
\makeatother
\urlstyle{leo}

% To make various LaTeX processors do the right thing with page size.
\def\pprw{8.5in}
\def\pprh{11in}
\special{papersize=\pprw,\pprh}
\setlength{\paperwidth}{\pprw}
\setlength{\paperheight}{\pprh}
\setlength{\pdfpagewidth}{\pprw}
\setlength{\pdfpageheight}{\pprh}

% Make sure hyperref comes last of your loaded packages, to give it a
% fighting chance of not being over-written, since its job is to
% redefine many LaTeX commands.
\definecolor{linkColor}{RGB}{6,125,233}
\hypersetup{%
  pdftitle={\plaintitle},
% Use \plainauthor for final version.
%  pdfauthor={\plainauthor},
  pdfauthor={\emptyauthor},
  pdfkeywords={\plainkeywords},
  bookmarksnumbered,
  pdfstartview={FitH},
  colorlinks,
  citecolor=black,
  filecolor=black,
  linkcolor=black,
  urlcolor=linkColor,
  breaklinks=true,
}

% create a shortcut to typeset table headings
% \newcommand\tabhead[1]{\small\textbf{#1}}

% End of preamble. Here it comes the document.
\begin{document}

\title{Finite Element Analysis and Bone Density Characterization for OsteoApp in Personal Osteoporosis Screening}

\numberofauthors{3}
\author{%
  \alignauthor{Baihan Lin\\
    \affaddr{UbiComp Lab}\\
    \affaddr{University of Washington}\\
    \affaddr{Seattle, WA 98105, USA}\\
    \email{doerlbh@gmail.com}}\\
}

\maketitle

\begin{abstract}
The project aims to conduct a finite element analysis (FEA) on a bone-like structure to simulate the vibration properties of a bone or arm. This simulation is supportive to OsteoApp, a smartphone app for personal osteoporosis screening that tests bone density and tells people if they are at risk for bone disease. OsteoApp uses a vibration technique that takes advantage of the accelerometers on a hand-held smartphone to measure bone stiffness and density, based on the vibrations that pass through the user's arm when the elbow is tapped. The FEA simulation and bone density frequency exploration in this study can help us better understand the physical relationship and proper methodology of the external tapping with the measured signals. In addition to the characterization of bone density properties, the study also brings up innovative mathematical and experimental approaches for further application developments in both acceleration/frequency-based and time delay-based contexts. This study is conducted by Baihan Lin, mentored by Morelle Arian and Josh Fromm, and supervised by Prof. Shwetak Patel.

\end{abstract}

\category{H.5.m.}{Information Interfaces and Presentation
 (e.g. HCI)}{Miscellaneous}{}{}

\keywords{signal processing, ubiquitous computing, health sensing, mobile phones, osteoporosis screening, finite elements analysis, spectrogram analysis, machine learning}

\section{Introduction}

Osteoporosis is a disease where increased bone weakness increases the risk of a broken bone. OsteoApp aims to utilize the accelerometers on a hand-held smartphone to measure bone strength, based on the vibrations that pass through the user's arm when the elbow is tapped. To facilitate the understanding of the relationship between the external tapping with the measured signals, finite element analysis (FEA) is applied, as a computerized method for predicting how a product reacts to real-world forces, vibration, heat, fluid flow, and other physical effects. The study aims to understand the information that accelerometers may be collecting based on the simulated properties of the bone-like structures, as well as proposing innovative mathematical and experimental approaches to measure bone density. 

\begin{enumerate}
   \item The study covered four stages:
	\begin{itemize}
	\item simulate a simplified bone-like structure
	\item simulate bone with more specifications
	\item formulate the equations of the signal properties
	\item develop mathematical and experimental methods to analyze bone density
	\end{itemize}

	\item For each models, FEA analyses was conducted:
	\begin{itemize}
	\item static stress analysis
	\item natural frequency analysis
	\item drop test analysis with rigid impact
	\item drop test analysis with flexible impact
	\item drop test analysis with damping effect
	\item linear dynamic modeling with modal damping 
	\end{itemize}

	\item Experimentally, data were collected and analyzed:
	\begin{itemize}
	\item linear sweep on real human bone
	\item linear sweep on my arm 
	\item linear sweep in different angles
	\item linear sweep in different surfaces
	\item sporadic tapping in different materials
	\item vibrator of the smartphone
	\item smartphone audio-speaker vibration
	\item time delay via audio recording
	\end{itemize}
\end{enumerate}

\section{Progress} 

UPDATE - \today: So far, I have conducted multiple simulations for a simplified combined model of bones (a wooden complex combining two bent rods). I also created the basic formula of the natural frequency of the bone. I experimentally tested the signal generated by accelerator under a frequency sweep as well as explored the possibility of measuring the elasticity of wood. I performed linear sweep on real human bone and my arm, and based on the analysis plots, determined which pose or solution is better for the product design. My mathematical calculations on the cantilever beam natural frequency match the experimental measurements. The result also confirms that horizontal vibration (phone on the side of the arm) has a larger input than from the bottom of the arm. I tested the quality of the signal from different materials of hammers to determine the most safe and reliable apparatus for vibration sources. It turns out that doesn't make much difference regarding the quality. For the possibility of using another phone as vibrator, I collaborated with Josh who worked on controlling the vibrator of the smart phone. It turned out that smart phones cannot easily change the frequencies of the vibrator and the signal is noisy. I have been cogitating about what would be the next step of my study as well as the OsteoApp in general. For example, the linear sweep may still be implemented with a smartphone audio-speaker (given loud enough setting) or a linear frequency motor. I also reflected on my previous method to extract the 3-dimensional accelerometer signal and improved it with a mathematical projection on the maximum propagating plane. To validate my findings last time on the selections of hitting materials, I plotted spectrograms for all previous signals and it doesn't highlight the natural frequencies like I expected. In addition, the signals by random impacts look similarly noisy in the spectrograms. To look for potential "lags" of signals at certain frequencies in the spectrograms, I automated the process to ensure a refined analysis each individual impulse. I extracted each single impulse out with a time frame of 1 second. However, while I expected the spectrogram to be having a lag of timing in certain frequency, the time lags are not that obvious. For the next step, I hypothesize that the a bigger hammer would make a clearer signal due to a bigger momentum to cause a better wide-band frequencies. To explore the possibility of using time delay as a indication of bone density, I created a pipeline to extract audio recording from both ends of the arm and calculated the least square time delay. Coming back into the drop test earlier, I explored on how different materials can have different accelerations with a purpose to capture a change in the frequency domain. 

\subsection{2017/03/30: Interview and Setup}

Morelle warmly introduced me to the project and we briefly discussed the general idea of the OsteoApp project as well as its current state. 

\subsection{2017/04/04: Decide on project}

Josh, Morelle and I discussed about the two directions of the supporting simulation analysis for OsteoApp. We decided that there are two major directions: one is to simulate the entire finite element analysis in SolidWorks; the other is to biophysically define and formulate the possible equations of bone vibration based on the limited physical properties of bone structures. 
After some discussion, we finally decided to start from SolidWorks simulations and later march towards mathematical formulation which is more creative and challenging.

\subsection{2017/04/11: Basic construction of model}

As shown in Figure~\ref{fig:arm_diagram} from $Grey's$ $Anatomy$ \cite{WikipediaEN:Arm}, the humerus is the (upper) arm bone which joins with the scapula above at the shoulder joint (or glenohumeral joint) and with the ulna and radius below at the elbow joint. The entire structure of bones is rather complicated considering the twisted and combined configuration.


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/human_arm_bones_diagram}
  \caption{Bones of the upper limbs, together with shoulder girdles together comprising the human arm}~\label{fig:arm_diagram}
\end{figure}


To simplify the arm structure, I first use femur bone model from GrabCAD \cite{SB:bone} for my initial simulation, with its shape shown and its mass properties shown in Figure \ref{fig:femur_property}. However, later I found that the calculation by SolidWorks took several hours for even the simplest simulation. I attributed this issue as the complexity of the real bone structure as well as its fine mesh mapping. 


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/femur_property}
  \caption{the femur model and its mass properties }~\label{fig:femur_property}
\end{figure}


Therefore, I created a 3D model of a simplified double bone of ulna and radius combined, shown in Figure \ref{fig:double_bone}. To create the bone, I assume an average adult has ulna and radius bone with an approximately 20mm in diameter each and 300mm in length with a flex of 15 degrees. I combined them together with a shared diameters of 2mm from the flex. 


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/double_bone}
  \caption{the double bone model}~\label{fig:double_bone}
\end{figure}


For the material selection applied for simulations, the bones are not fully solid but made up of a network of matter with pores. In addition, most of the largest bones are hollow and each bone also contains blood vessels, nerve cells and living bone cells known as osteocytes. These are held together by a framework of hard, non-living material containing calcium and phosphorous. A thin membrane called the periosteum covers the surface of your bones. Based on different density, bone can either be spongy or compact. Therefore, I suppose the nearest to bone would be a composite of some sort or hard-wood, because trunks also consist of cells with cell walls like bone structures. From the material categories, I chose balsa wood as the structure with properties shown in Figure \ref{fig:db_balsa}.

\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/db_balsa}
  \caption{the material properties of balsa wood applied to the designed double bone model}~\label{fig:db_balsa}
\end{figure}

\subsubsection{Static stress analysis}

With a fixed point on the top of the bone as a hand holding smartphone, the simulation exert a static 20N force in a direction normal to the bottom of the combined double bone model, resembling the movement of tapping the elbow.

The static stress analysis doesn't inform much about frequency signals. However, as shown in Figure \ref{fig:db_stat_ana}, it offers helps information on the biggest strain of the model, which can also be the noisiest location to collect signals. This can possibly imply the evaluation of signal qualities based on certain posture of holding the phone.


\begin{figure*}
\centering
  \includegraphics[width=1.95\columnwidth]{figures/db_stat_ana}
  \caption{the static stress analysis of the double bone model in (a) stress, (b) displacement and (c) strain.}~\label{fig:db_stat_ana}
\end{figure*}


\subsubsection{Natural frequency analysis}

Natural Frequencies are the fundamental frequencies whose multiples are called "harmonics". The model structures tend to vibrate with a particular mode shape at each frequency. Dynamic loads coinciding with a natural frequency can cause resonance. Therefore, we can measure its natural frequency as a potential signal indicator via resonance. Damping exists in real structures to limit the response.

It is also noted that, natural frequencies and mode shapes depend on geometry, material properties and mass, support conditions (fixtures) and in-plane loads. Many of these factors have been simplified by assumptions which can be different from a real bone structures. Thus, further study can be conducted to explore these factors. In addition, real structures have infinite numbers of natural frequencies and modal shapes, but in finite element models we use, they only have a finite number.

The simulation indicates a wide variety of possible harmonic vibrations, as shown from Figure \ref{fig:db_freq1}. The relationship of mode number with natural frequencies were not purely linear, demonstrated by Table \ref{tab:db_freq} and Figure \ref{fig:db_freq1_graph1}.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_freq1}
  \caption{natural frequency analysis for double bone}
    ~\label{fig:db_freq1}
\end{figure*}

\begin{table}
  \centering
  \begin{tabular}{l r r r}
    % \toprule
    & & \multicolumn{2}{c}{\small{\textbf{Frequency}}} \\
    \cmidrule(r){3-4}
    {\small\textit{Mode No.}}
    & {\small \textit{Period (s)}}
      & {\small \textit{(Rad/s)}}
    & {\small \textit{(Hertz)}} \\
    \midrule
    1 & 0.0076324 & 823.23 & 131.02 \\
    2 & 0.0051459 & 1221 & 194.33 \\
    3 & 0.0014234 & 4414.1 & 702.53 \\
    4 & 0.0012319 & 5100.4 & 811.76 \\
    5 & 0.0011668 & 5384.9 & 857.04 \\
    % \bottomrule
  \end{tabular}
  \caption{natural frequencies in different modes for double bone model}~\label{tab:db_freq}
\end{table}

\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/db_freq1_graph1}
  \caption{natural frequency vs. mode number for double bone}~\label{fig:db_freq1_graph1}
\end{figure}


\subsubsection{Drop test analysis with rigid impact}

In a drop test analysis, the time varying stresses and deformations due to an initial impact of the product with a rigid or flexible planar surface (the floor) are calculated. I found this simulation interesting because the idea of tapping elbow resembles dropping the elbow on a desk or hand. 

I found another variable very useful that is generated in the analysis, "Translational Acceleration" in $mm/s^2$, because I think this signal could potentially resemble the signal sensed by the accelerometers in smartphones.

In Drop Test 1, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0. I also consider it to drop to a stiff surface, so I set target stiffness = rigid, with result shown in Figure \ref{fig:db_dt1_ana}. 

Interestingly, if we consider the time graph of the translational acceleration (Figure \ref{fig:db_dt1_res}) as described previously, we can see that the signals have their unique patterns. Node 1 and 2 were both collected at the very end, and they responded different from Node 7 in a more middle position.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt1_ana}
  \caption{analysis for Drop Test 1 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt1_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt1_res}
  \caption{response graphs for Drop Test 1 for double bone in three different location (nodes).}
    ~\label{fig:db_dt1_res}
\end{figure*}

\subsubsection{Drop test analysis with flexible impact}

In Drop Test 2, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0. I also consider it to drop to a flexible surface, so I set target stiffness = flexible, with result shown in Figure \ref{fig:db_dt2_ana}. 

I found this case interesting because this resembles the tapping of elbow by hand palm which is a flexible surface with certain thickness. From the animation I also observe such absorption of vibrations and delay of transduction.

If we consider the time graph of the translational acceleration (Figure \ref{fig:db_dt2_res}), we can see that the signals are in fact very different from the Drop Test 1 in the same locations. This implies that the material of the tapping objects is a very important factor in the signal identification.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt2_ana}
  \caption{analysis for Drop Test 2 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt2_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt2_res}
  \caption{response graphs for Drop Test 2 for double bone in three different location (nodes).}
    ~\label{fig:db_dt2_res}
\end{figure*}


\subsubsection{Drop test analysis with damping effect}

In Drop Test 3, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0.5. I also consider it to drop to a stiff surface, so I set target stiffness = rigid, with result shown in Figure \ref{fig:db_dt3_ana}, which is very similar to Drop Test 1. Such similarity also arises in the time graph of the translational acceleration (Figure \ref{fig:db_dt3_res}). Arguably speaking, this doesn't support the importance of damping effect in signal feature extraction later in OsteoApp development. 

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt3_ana}
  \caption{analysis for Drop Test 3 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt3_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt3_res}
  \caption{response graphs for Drop Test 3 for double bone in three different location (nodes).}
    ~\label{fig:db_dt3_res}
\end{figure*}

\subsection{2017/04/18: Frequency Propagation of double bone model}

After discussion, we decided to expand the analysis into a design where the vibration signal of a certain frequency is provided at one end of the bone. This is to simulate a proposed engineering design that the user put his or her arm onto the surface of a smart phone which generates a certain frequency, then another smart phone, held in the hand of the arm, records the propagated frequencies with accelerators to determine the bone density.

Therefore, instead of the original design where only one impulse is provided, a constant vibration of a certain frequency is provided. There are no obvious built-in SolidWorks package to facilitate this design, but I found "Linear Dynamic Simulation", which uses frequencies and mode shapes to study linear response to dynamic loading, promising for our analysis.

\subsubsection{Linear dynamic modeling of frequency propagation} 

Earlier, I was trying to perform linear dynamic modeling would be a very interesting simulation because it can take into account the impact of a ball towards the bone, which can support an existing measurement equipment in the lab. Unfortunately, when I was running the simulations, the SolidWorks crashed several times and never made to the end. I will re-attempt this simulation. The following is to simulate the frequency propagation.

I attempted to create a harmonic dynamic simulation. In doing so, one essential step is to create a periodic force as the constant impulse and record the time steps of the propagation. Searching for different resources, I found it currently infeasible for such task. Consulting several friends in mechanical engineering and material sciences, they suggest that SolidWorks was mostly used for model design and ANSYS is the common software for simulations, so I decide to switch gear to ANSYS.

\subsubsection{FEA with ANSYS} 

ANSYS is only available through ME departmental access in the remote desk top. To specify material properties of the bone, there is only one built-in material available in their package, thus, when specifying a new type of material, I defined the density to be 1900 $kg/m^3$ from \cite{Cameron:1999:Physics}. So far, the ANSYS simulation has not been fully finished yet. 

However, in the midst, some of my friends in mechanical engineering let me know that such simulation, even done by ANSYS, will be very difficult if possible as all. Normally, they would just use a vibrator and experiment on the material itself through manual frequency tuning instead of simulation. 

\subsubsection{Cogitation about the propagation process} 

Let's take a step back and think of the process, as shown in equation \eqref{eq:mot1}\eqref{eq:mot2}, an external frequency input would not observe a change in frequency when propagation. The propagation created a phase change and uneven amplitude due to resonance of the material. 

How to define the density of a material, in our case, the bone, is more or less related to the natural frequency of the material. In our experimental design, the way to experimentally determine the frequency is to exert an external frequency changing within a wide range and find the biggest amplitude recorded, which would be the natural frequency which causes resonance.  

\subsubsection{Initial formulation of the frequency analysis} 

Mechanical impedance is a measure of how much a structure resists motion when subjected to a harmonic force. The motion function can be formulated as:

\begin{equation} \label{eq:mot1}
mx''+cx'+kx=f(t)={\bf F}e^{jwt}
\end{equation}

where $f(t)$ is the external force with a harmonic oscillation. Thus, the corresponding harmonic oscillation induced by the external force: 

\begin{equation} \label{eq:mot2}
x={\bf X}e^{j\omega t}, x'={\bf V}e^{j \omega t}=j\omega{\bf X}e^{j\omega t}, x''={\bf A}e^{j \omega t}=-\omega^2{\bf X}e^{j \omega t}
\end{equation}

From many aspect, our question is very similar to the classic beam question. There are several predefined properties discovered in the beam studies which could offer insights into our analysis. If we consider the bone as a beam, for example, a cantilever beam (because one end is attached to the smart phone as a fixed point), then its natural frequency can be expressed by the following \cite{Young:2002:formula}:

\begin{equation} \label{eq:beam}
f_1=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{EI}{w}}=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{EI}{\rho A}}
\end{equation}

where $f_1$ is the natural frequency of the cantilever beam (bone) with uniform load $w$ per unit length including beam (bone) weight; $L$ is the length of the beam (bone); $E$ is the modulus of elasticity of the material; $I$ is the area moment of inertia, a geometrical parameter based on the intersection of the beam (bone); and normally, we take constant $\alpha_1 = 1.875$.

What is interesting in this formula is how bone structure can be specified differently here. The area of inertia can be different as the structural properties of the bone is a porous complex. I can try treating each individual pore as one unit and sum them up together. In addition, the elasticity of the bone is relatively undefined. Other than calculation, another more direct way would be to do an elasticity measurement of a real bone. 
 
The real application in OsteoApp would have more to consider. Not only in our formula it displays that length of arm is a factor to determine natural frequency (something to be collected during user experiments). Moreover, with the addition of muscle, it would be two separate materials instead of one. In that analysis, we need to calculate two natural frequencies separately and combine their amplitudes together to be our estimated signal during measurements. 

\subsection{2017/04/23: Experiment and measurements}

I experimentally tested the signal generated by accelerator under a frequency sweep as well as explored the possibility of measuring the elasticity of wood. 

\subsubsection{How to measure the modulus of elasticity} 

From the equation \eqref{eq:beam} of natural frequency for cantilever beam, $E$ is the modulus of elasticity of the material. How can we measure the modulus of elasticity? Young's modulus, also known as the elastic modulus, is a measure of the stiffness of a solid material. It is a mechanical property of linear elastic solid materials. It defines the relationship between stress (force per unit area) and strain (proportional deformation) in a material. The velocity measurements for modulus calculation are most commonly made with precision thickness gages such as models 38DL PLUS (Figure \ref{fig:plastic-modulus}) and 45MG with Single Element software,  or a flaw detector with velocity measurement capability such as the EPOCH series instruments. Pulser/receivers such as the Model 5072PR or 5077PR can also be used with an oscilloscope or waveform digitizer for transit time measurements. 

\begin{figure}
\centering
  \includegraphics[width=0.5\columnwidth]{figures/plastic-modulus}
  \caption{Olympus 38DL PLUS}~\label{fig:plastic-modulus}
\end{figure}

However, another viable option for our modeling, is that I found a measured number for Young's modulus of the bone. For example, Young's modulus of trabecular and cortical bone material is available by Ultrasonic and microtensile measurements \cite{boneYoung} as 14.8 GPa (S.D. 1.4) and 10.4 (S.D. 3.5) for trabecular bone and 20.7 GPa (S.D. 1.9) and 18.6 GPa (S.D. 3.5) for cortical bone.

\subsubsection{Frequency sweep experiment via raspberry pi} 

The frequency sweep was set as a linear sweep from 0 to 1000Hz in a time range of 60 seconds. Thus, in the data collection of accelerometers via raspberry pi, I set the time collection to be 70 seconds (see referenced code daisychain\_baihan.py). I performed 4 experiments each with 5 runs (Figure \ref{fig:pose} and Table \ref{tab:sweep}): 
\begin{itemize}
\item 5 times with accelerometer facing the vibrator (pose 1)
\item 5 times with accelerometer backing the vibrator (pose 2)
\item 5 times with the rod's bottom being vibrated (pose 3)
\item 5 times with accelerometer beside the vibrator (pose 4)
\end{itemize}

\begin{table*}
  \centering
  \begin{tabular}{l r r r r }
    No.
    & {\small{\textbf{Pose 1}}} 
    & {\small{\textbf{Pose 2}}}
    & {\small{\textbf{Pose 3}}} 
    & {\small{\textbf{Pose 4}}} \\
   1 & acc0\_04\_24\_00\_04\_56 & acc0\_04\_24\_00\_15\_16 & acc0\_04\_24\_00\_32\_31 & acc0\_04\_24\_00\_48\_49 \\
   2 & acc0\_04\_24\_00\_07\_20 & acc0\_04\_24\_00\_16\_51 & acc0\_04\_24\_00\_34\_11 & acc0\_04\_24\_00\_50\_59 \\
   3 & acc0\_04\_24\_00\_09\_23 & acc0\_04\_24\_00\_25\_36 & acc0\_04\_24\_00\_35\_57 & acc0\_04\_24\_00\_52\_26 \\
   4 & acc0\_04\_24\_00\_11\_14 & acc0\_04\_24\_00\_27\_10 & acc0\_04\_24\_00\_41\_09 & acc0\_04\_24\_00\_54\_06 \\
   5 & acc0\_04\_24\_00\_13\_16 & acc0\_04\_24\_00\_28\_50 & acc0\_04\_24\_00\_43\_52 & acc0\_04\_24\_00\_55\_42\\
  \end{tabular}
  \caption{references for the linear sweep experiments}~\label{tab:sweep}
\end{table*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose}
  \caption{4 poses for accelerometers measurement: (a) accelerometer facing the vibrator; (b) accelerometer backing the vibrator; (c) the rod's bottom being vibrated; (d) accelerometer beside the vibrator.}
    ~\label{fig:pose}
\end{figure*}

Pose 1 is the most probable way during our real measurement. Pose 2 and 4 is to explore whether the direction of the acceleromoters make a difference. Pose 3 is to simulate the condition where the vibration input is coming from the bottom of the arm where the bone is most directly attached.

\subsubsection{Frequency analysis of measured data} 

In the csv files generated by the raspberry pi, the three numbers in each row (time step) indicate the acceleration in x, y, and z axis (as shown in the python code). To get the frequency, I have several ideas: I. Take acceleration as frequency itself to calculate the proportion: just treat the dimension with biggest vibration or take the norm-2 (geometric) of the three. II. Find the frequency by plotting out dynamics: take the acceleration as gradient and plot the vibrations. I finally decided to treat the biggest acceleration axis as the input. 

To rearrange the data files and plot them out, I coded a bash script to generate a MATLAB code and save all the matrices into a .mat file (see referenced code csv2mat\_baihan.sh). Then, to automate the process, I coded another bash script to generate another MATLAB code for analyzing and plotting the data (see referenced code analysis\_baihan.sh). Inside the code, I first select out the period during which the experiment is on.

From Figure \ref{fig:pose1_1} to \ref{fig:pose4_5}, we can see that accelerometer facing the vibrator (pose 1) or tapped on the bottom of the rod (pose 3) gave the most consistent results. I assume the acc0 measured the position where the hand is holding the smart phone and the acc1 measured the source of vibration. Thus, as shown in the figures, proportion of signal from acc0 over signal of acc1 gave clearer results on potential natural frequencies.

However, it is noted that the biggest amplitudes doesn't always occur at the same frequency in different poses. For pose 1, the peak seems to be within the range about 100 Hz. For pose 2, the peak seems to be within the range 300 Hz. For pose 3, the peak seems to be within the range 100~200 Hz. For pose 4, the peak seems to be within the range 100~200 or 300 Hz.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_1}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 1}
    ~\label{fig:pose1_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_2}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 2}
    ~\label{fig:pose1_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_3}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 3}
    ~\label{fig:pose1_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_4}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 4}
    ~\label{fig:pose1_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_5}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 5}
    ~\label{fig:pose1_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_1}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 1}
    ~\label{fig:pose2_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_2}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 2}
    ~\label{fig:pose2_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_3}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 3}
    ~\label{fig:pose2_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_4}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 4}
    ~\label{fig:pose2_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_5}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 5}
    ~\label{fig:pose2_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_1}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 1}
    ~\label{fig:pose3_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_2}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 2}
    ~\label{fig:pose3_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_3}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 3}
    ~\label{fig:pose3_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_4}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 4}
    ~\label{fig:pose3_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_5}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 5}
    ~\label{fig:pose3_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_1}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 1}
    ~\label{fig:pose4_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_2}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 2}
    ~\label{fig:pose4_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_3}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 3}
    ~\label{fig:pose4_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_4}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 4}
    ~\label{fig:pose4_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_5}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 5}
    ~\label{fig:pose4_5}
\end{figure*}

\subsection{2017/04/30: Sweep experiments on bone and arm} 

The frequency sweep was set as a linear sweep from 0 to 1000Hz in a time range of 60 seconds. Thus, in the data collection of accelerometers via raspberry pi, I set the time collection to be 70 seconds (see referenced code daisychain\_baihan.py). I performed 4 experiments each with 5 runs (Figure \ref{fig:PoseTest2} and Table \ref{tab:sweep2}): 
\begin{itemize}
\item 5 times with accelerometer facing the vibrator (pose 1)
\item 5 times with accelerometer backing the vibrator (pose 2)
\item 5 times with the rod's bottom being vibrated (pose 3)
\item 5 times with accelerometer beside the vibrator (pose 4)
\end{itemize}

\begin{table*}
  \centering
  \begin{tabular}{l r r r r }
    No.
    & {\small{\textbf{Pose 5}}} 
    & {\small{\textbf{Pose 6}}}
    & {\small{\textbf{Pose 7}}} 
    & {\small{\textbf{Pose 8}}} \\
   1 & acc0\_04\_30\_21\_26\_32 & acc0\_04\_30\_21\_44\_43 & acc0\_04\_30\_21\_57\_49 & acc0\_04\_30\_22\_09\_23 \\
   2 & acc0\_04\_30\_21\_28\_21 & acc0\_04\_30\_21\_46\_17 & acc0\_04\_30\_21\_59\_16 & acc0\_04\_30\_22\_11\_03 \\
   3 & acc0\_04\_30\_21\_29\_52 & acc0\_04\_30\_21\_47\_59 & acc0\_04\_30\_22\_00\_51 & acc0\_04\_30\_22\_12\_36 \\
   4 & acc0\_04\_30\_21\_33\_02 & acc0\_04\_30\_21\_49\_27 & acc0\_04\_30\_22\_03\_00 & acc0\_04\_30\_22\_14\_46 \\
   5 & acc0\_04\_30\_21\_33\_01 & acc0\_04\_30\_21\_50\_59 & acc0\_04\_30\_22\_04\_28 & acc0\_04\_30\_22\_16\_40 \\
  \end{tabular}
  \caption{references for the linear sweep experiments round 2}~\label{tab:sweep2}
\end{table*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/PoseTest2}
  \caption{Pose 5~8 for accelerometers measurement: (a) bone hitting the vibrator horizontally; (b) bone hitting the vibrator vertically; (c) vibrating under arm bottom; (d) vibrating horizontally towards the arm.}
    ~\label{fig:PoseTest2}
\end{figure*}

As shown in Figure \ref{fig:PoseTest2}, Pose 5 and 6 were tested on a bone while Pose 7 and 8 were tested on my arm. Pose 6 and 7 are to simulate the condition where the vibration input is coming from the bottom of the arm where the bone is most directly attached, while Pose 5 and 8 are to simulate the condition where the vibration signals come from the vertical direction of the arm. 

\subsubsection{Estimated frequency based on calculation} 

Given the distance between two accelerometers on the wood rod is 27.5 cm, radius 1.5 cm, density as pine ($480kg/m^3$), elasticity as oak (12.5 GPa), based on the formula for natural frequency of a cantilever beam (we take constant $\alpha_1 = 1.875$):

\begin{align} \label{eq:beam}
f_1&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{EI}{w}} \\
&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{E\pi r^4 / 2}{\rho \pi r^2}} \\
&=\frac{1.875^2}{2\pi 0.275^2}\sqrt[]{\frac{12500000000 \times 0.015^2/2}{480}} \\
&=400.468 Hz
\end{align}

Given the distance between two accelerometers on the bone is 18 cm, radius 1 cm, density as $1900 kg/m^3$, elasticity as 14.8 GPa, based on the formula for natural frequency of a cantilever beam (we take constant $\alpha_1 = 1.875$):

\begin{align} \label{eq:beam}
f_1&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{EI}{w}} \\
&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{E\pi r^4 / 2}{\rho \pi r^2}} \\
&=\frac{1.875^2}{2\pi 0.18^2}\sqrt[]{\frac{14800000000 \times 0.01^2/2}{1900}} \\
&=340.813 Hz
\end{align}

Given the distance between two accelerometers on the arm is 29 cm, radius 2 cm, density as pure bone $1900 kg/m^3$, elasticity as pure bone 14.8 GPa, based on the formula for natural frequency of a cantilever beam (we take constant $\alpha_1 = 1.875$): 

\begin{align} \label{eq:beam}
f_1&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{EI}{w}} \\
&=\frac{\alpha_1^2}{2\pi L^2}\sqrt[]{\frac{E\pi r^4 / 2}{\rho \pi r^2}} \\
&=\frac{1.875^2}{2\pi 0.29^2}\sqrt[]{\frac{14800000000 \times 0.02^2/2}{1900}} \\
&=681.626 Hz
\end{align}

\subsubsection{Frequency analysis of measured data} 

Like earlier, I rearranged the data files and plotted the accelerometer data out with two original bash scripts to generate a MATLAB codes for analyzing and plotting the data. In addition, I wrote another script (replot\_baihan.sh) to rearrange the generated plots into groups based on their individual test.

From Figure \ref{fig:t2_1} to \ref{fig:t2_20}, we can see that other than Pose 7 (vibrator hitting arm bottom), most poses gave relatively consistent results. Like last time, I assume the acc0 measured the position where the hand is holding the smart phone and the acc1 measured the source of vibration. Thus, as shown in the figures, proportion of signal from acc0 over signal of acc1 gave clearer results on potential natural frequencies.

However, it is noted that the biggest amplitudes doesn't always occur at the same frequency in different poses, even in the same material. For pose 5, the peak seems to be at ~200, ~300, ~480 Hz. For pose 6, the peak seems to be within the range 100 Hz. For pose 7, the peak seems to ~50 and ~300 Hz. For pose 8, the peak seems to be within the range ~250 Hz.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_1}
  \caption{accelerometer signals vs. frequency swept in pose 5 experiment 1}
    ~\label{fig:t2_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_2}
  \caption{accelerometer signals vs. frequency swept in pose 5 experiment 2}
    ~\label{fig:t2_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_3}
  \caption{accelerometer signals vs. frequency swept in pose 5 experiment 3}
    ~\label{fig:t2_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_4}
  \caption{accelerometer signals vs. frequency swept in pose 5 experiment 4}
    ~\label{fig:t2_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_5}
  \caption{accelerometer signals vs. frequency swept in pose 5 experiment 5}
    ~\label{fig:t2_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_6}
  \caption{accelerometer signals vs. frequency swept in pose 6 experiment 1}
    ~\label{fig:t2_6}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_7}
  \caption{accelerometer signals vs. frequency swept in pose 6 experiment 2}
    ~\label{fig:t2_7}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_8}
  \caption{accelerometer signals vs. frequency swept in pose 6 experiment 3}
    ~\label{fig:t2_8}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_9}
  \caption{accelerometer signals vs. frequency swept in pose 6 experiment 4}
    ~\label{fig:t2_9}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_10}
  \caption{accelerometer signals vs. frequency swept in pose 6 experiment 5}
    ~\label{fig:t2_10}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_11}
  \caption{accelerometer signals vs. frequency swept in pose 7 experiment 1}
    ~\label{fig:t2_11}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_12}
  \caption{accelerometer signals vs. frequency swept in pose 7 experiment 2}
    ~\label{fig:t2_12}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_13}
  \caption{accelerometer signals vs. frequency swept in pose 7 experiment 3}
    ~\label{fig:t2_13}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_14}
  \caption{accelerometer signals vs. frequency swept in pose 7 experiment 4}
    ~\label{fig:t2_14}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_15}
  \caption{accelerometer signals vs. frequency swept in pose 7 experiment 5}
    ~\label{fig:t2_15}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_16}
  \caption{accelerometer signals vs. frequency swept in pose 8 experiment 1}
    ~\label{fig:t2_16}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_17}
  \caption{accelerometer signals vs. frequency swept in pose 8 experiment 2}
    ~\label{fig:t2_17}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_18}
  \caption{accelerometer signals vs. frequency swept in pose 8 experiment 3}
    ~\label{fig:t2_18}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_19}
  \caption{accelerometer signals vs. frequency swept in pose 8 experiment 4}
    ~\label{fig:t2_19}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/t2_20}
  \caption{accelerometer signals vs. frequency swept in pose 8 experiment 5}
    ~\label{fig:t2_20}
\end{figure*}

\subsection{2017/05/14: Real-life implementation of apparatus} 

For real life condition, I collaborated with Josh who worked on controlling the vibrator of the smartphone. It turned out that smartphones cannot easily change the frequencies of the vibrator. Thus, I tested the quality of the signal from different materials of hammers to determine the most safe and reliable apparatus for vibration sources. I performed 4 experiments each with 70 seconds (Figure \ref{fig:hit}: 
\begin{itemize}
\item Soft big-head hammer (pose 9)
\item Soft small-head hammer (pose 10)
\item Hard flat-head hammer (pose 11)
\item Hard round-head hammer (pose 12)
\end{itemize}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/hit}
  \caption{Pose 9 to 12 for accelerometers measurement: (a) Soft big-head hammer; (b) Soft small-head hammer; (c) Hard flat-head hammer; (d) Hard round-head hammer.}
    ~\label{fig:hit}
\end{figure*}

\subsubsection{Analysis of different types of hammers} 

From Figure \ref{fig:hit_1} to \ref{fig:hit_4}, we can see that the soft versus hard materials of the hammers doesn't create much differences in the quality of the signals (they both showed clear signals without much noises). This can imply that a soft-head hammer is good enough as our vibrator, which is beneficial in the case of measuring bone density in elder people whose bones are rather fragile. 

On the other hand, it demonstrated again that the relative amplitude of the source (acc0) versus the propagated end (acc1) cannot correspond to its impact frequency well. This yields a standing question that how we can find out a way to extract frequency information from our random impact.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/hit_1}
  \caption{accelerometer signals vs. time in pose 9: soft big-head hammer.}
    ~\label{fig:hit_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/hit_2}
  \caption{accelerometer signals vs. time in pose 10: soft small-head hammer.}
    ~\label{fig:hit_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/hit_3}
  \caption{accelerometer signals vs. time in pose 11: hard flat-head hammer.}
    ~\label{fig:hit_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/hit_4}
  \caption{accelerometer signals vs. time in pose 12: hard round-head hammer.}
    ~\label{fig:hit_4}
\end{figure*}

\subsubsection{Smartphone vibrator analysis} 

Josh and I tested the acceleration output from the built-in smartphone vibrator. Josh added a button inside osteoApp so that we could make the smartphone when we clicked on it. As shown in Figure \ref{fig:vib}, the vibration itself can be captured by the accelerometers, but it is very hard to extract the frequency or other useful information from the signal.

It is also noted that, the signals from the vibration of the smartphone are very noisy. This might be due to the fact that the vibration motors inside the phone utilizes an uneven shape (Figure \ref{fig:vibrator}), and the frequency of the vibration depends on the innate motor speed which is often set constant. This implies that building a linear sweep is relatively hard and extracting the exact frequency from a phone as our vibration source is probably not optimal.

\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/vibrator}
  \caption{the design of a phone vibration motor}~\label{fig:vibrator}
\end{figure}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/vib}
  \caption{accelerometer signals vs. time in smartphone vibrator analysis in take 1~4.}
    ~\label{fig:vib}
\end{figure*}


\subsection{2017/05/22: Mathematical improvement and reflection}

From my results last weeks, I have been cogitating about what would be the next step of my study as well as the osteoApp in general. For example, the linear sweep may still be implemented with a smartphone audiospeaker (given loud enough setting) or a linear frequency motor. I also reflected on my previous method to extract the 3-dimensional accelerometer signal and improved it with a mathematical projection on the maximum propagating plane. To validate my findings last time on the selections of hitting materials, I plotted spectrograms for all previous signals and it doesn't highlight the natural frequencies like I expected. In addition, the signals by random impacts look similarly noisy in the spectrograms.

\subsubsection{Reflections on future directions} 

From my results last weeks, I have been cogitating about what would be the next step of my study as well as the osteoApp in general. Discussing with Shwetak, we think that due to a much better quality of signal we have obtained, the linear sweep may still be implemented in osteoApp, only instead of using a external vibrator, possibly with a smartphone audiospeaker (given loud enough setting) or a linear frequency motor (found in certain phone). However, the possible challenge is that the phone audiospeaker may not have strong enough force to make a propagatible wave. Discussing with Morelle, we decided a portable linear motor may be the next step of story.

\subsubsection{Improved accelerometer signal with maximum projection} 

I also reflected on my previous method to extract the 3-dimensional accelerometer signal. I found that previously I utilized norm-2 or Euclidean distance of the signal. The drawback of this is that it loses all the negativity of the signal, only positive, which gives up the directionality of the wave. In addition, taking the maximum of the three axis might not grant the most consistent signal as the two accelerometers may be measuring in different orientation. Thus, my solution is to find the 3-dimensional plane that grants the biggest signal amplitudes. I derived the plane, or positive direction, by treating the variance in three axis as a super-positioned vector system. Then, the signals would then be a projection onto this positive direction, as shown in equation \eqref{eq:proj} below.

\begin{equation} \label{eq:proj}
proj_{\bf a}^{\bf b}=\frac{\bf a *\bf b}{\|\bf b\|}\frac{\bf a}{\|\bf a\|}
\end{equation}

\subsubsection{Spectrograms offer more detailed information about existing experiments} 

I replotted all the accelerometers signals in spectrograms, with a sampling rate of 0.0003 secs, NFFT of 1024, Fs of 1/0.0003, window size of 100 samples, overlap of 90. From Figure \ref{fig:tex_1234} and Figure \ref{fig:tex_5678}, we can see that the linear sweep is displayed, however with unique textures uncertain of reasons. From Figure \ref{fig:tex_mat}, it looks like the signals were more flat then outstanding, therefore, not much can be told by our naked eyes. Perhaps machine learning can grant us more insights onto these images.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/tex_mat}
  \caption{Spectrograms for the four experiments previously on the signal difference hitting with different materials.}
    ~\label{fig:tex_mat}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.6\columnwidth]{figures/tex_1234}
  \caption{Spectrograms for the four experiments previously in Pose 1 through 4.}
    ~\label{fig:tex_1234}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.6\columnwidth]{figures/tex_5678}
  \caption{Spectrograms for the four experiments previously in Pose 5 through 8.}
    ~\label{fig:tex_5678}
\end{figure*}

\subsection{2017/05/29: More refined spectrogram analysis}

Building upon my finding in last week, that spectrograms across entire time span are not fine enough to analyze each individual impulse, I extracted each single impulse out with a time frame of 1 second, such as the example demonstrated in Figure \ref{fig:impspec_acc0_05_14_20_32_44_160578}. However, while I expected the spectrogram to be having a lag of timing in certain frequency, as shown in Figure \ref{fig:Tex_impspec_acc0_09} through \ref{fig:Tex_impspec_acc1_12}, the time lags are not that obvious. For the next step, I hypothesize that the a bigger hammer would make a clearer signal due to a bigger momentum to cause a better wide-band frequencies.

\begin{figure}
  \centering
  \includegraphics[width=0.9\columnwidth]{figures/impspec_acc0_05_14_20_32_44_160578}
  \caption{Impulse spectrograms of $acc0\_05\_14\_20\_32\_44$ at time step 160578 for pose 12.}
    ~\label{fig:impspec_acc0_05_14_20_32_44_160578}
\end{figure}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc0_09}
  \caption{Impulse spectrograms of acc0 for pose 9.}
    ~\label{fig:Tex_impspec_acc0_09}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc1_09}
  \caption{Impulse spectrograms of acc1 for pose 9.}
    ~\label{fig:Tex_impspec_acc1_09}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc0_10}
  \caption{Impulse spectrograms of acc0 for pose 10.}
    ~\label{fig:Tex_impspec_acc0_10}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc1_10}
  \caption{Impulse spectrograms of acc1 for pose 10.}
    ~\label{fig:Tex_impspec_acc1_10}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc0_11}
  \caption{Impulse spectrograms of acc0 for pose 11.}
    ~\label{fig:Tex_impspec_acc0_11}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc1_11}
  \caption{Impulse spectrograms of acc1 for pose 11.}
    ~\label{fig:Tex_impspec_acc1_11}
\end{figure*}
\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc0_12}
  \caption{Impulse spectrograms of acc0 for pose 12.}
    ~\label{fig:Tex_impspec_acc0_12}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/Tex_impspec_acc1_12}
  \caption{Impulse spectrograms of acc1 for pose 12.}
    ~\label{fig:Tex_impspec_acc1_12}
\end{figure*}


\subsection{2017/06/08: Time delay analysis}

To explore the possibility of using time delay as a indication of bone density, we experimentally tested the audio recording systems for the two ends of an arm and the signals were similar. There are two challenges, the first one is how we can determine the time delay. If we use the point the signal past zero, the signal might not be one-to-one. Another challenge is that we need to make sure our measurement is sensitive enough to capture the break points. Thus, we finally adopted a high frequency audio inputs and I proposed a statistic approach, treating one signal as an estimated function to the other one, only with a phase change, which is the time delay.

I created a pipeline to extract audio recording from both ends of the arm and calculated the least square time delay. As shown in Figure \ref{fig:may30_timedelay}, I did a fast Fourier transformation to cancel unnecessary noise. Using iterative method of least square mean error, the time delay is calculated to be 47 sample points for the real part of data after FFT and 89 sample points for original data points. With a sampling rate of 47000 Hz, the calculated time delay, in air it should be about $47000Hz/340m/s*0.25m = 34.56$, and in bone should be about $47000Hz/3700m/s*0.25m = 3.17$. Thus, this time delay is within the range of the audible part via air. It is necessary to find another solution to capture the relatively small time delay traveled through bone.

\begin{figure}
  \centering
  \includegraphics[width=0.9\columnwidth]{figures/may30_timedelay}
  \caption{original audio recordings from both ends of the arm in to measure time delay (experiment on May 30)}
    ~\label{fig:may30_timedelay}
\end{figure}

\subsection{2017/06/15: Frequency range analysis on acceleration}

Back towards the drop test earlier, as proposed by Morelle, I wish to explore on how different materials can have different accelerations with a purpose to capture a change in the frequency domain. Still the double bone model, in a drop test analysis, the time varying stresses and deformations due to an initial impact of the product with a rigid or flexible planar surface (the floor) are calculated. Again, I looked into the interesting variable "Translational Acceleration" in $mm/s^2$, because I think this signal could potentially resemble the signal sensed by the accelerometers in smartphones.

In this Drop Test 4, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0. I also consider it to drop to a stiff surface, so I set target stiffness = rigid. The plan is to vary the materials similar to bone and drop the bone horizontally from the side to measure acceleration from both ends. 

Next step would be figuring out how to change the material properties of the bone to do this comparative study, as well as researching whether there is any similar prior study.

\section{Supplementary information}

For complete datasets measured in the experiments, high resolution images demonstrated in the article and testing codes, please refer to my GitHub repository: \url{https://github.com/doerlbh/UbiComp_OsteoApp_FEA}.

\section{Codes}

\subsection{Original: $csv2mat\_baihan.sh$}\label{ss:csv2mat}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: csv to mat
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

folder=`pwd`
for f in `ls *csv`
do
    mname=${f//.csv/}
    cat $mname.csv | tr '\n' ';' > $mname.list 
    sed -i -e "s/^/${mname}=[/" $mname.list
    sed -i -e 's/$/];/' $mname.list
done

cat *list > ${folder//*\//}_data_baihan.m
echo "save('${folder//*\//}');" >> ${folder//*\//}_data_baihan.m
rm *.list*

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop -r "${folder//*\//}_data_baihan"
\end{lstlisting}

\subsection{Original: $sweep\_analysis\_baihan.sh$}\label{ss:swp_ana.sh}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: sweep analysis
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

folder=`pwd`
mscript=${folder//*\//}_sweep_analysis_baihan.m
echo "% analysis.m for experiment ${folder//*\//} \n% Baihan Lin, Apr 2017\n" > $mscript

echo "clear all; close all;" >> $mscript
echo "\nload('${folder//*\//}.mat')\n" >> $mscript
echo "path=('$folder/out/');\n
system(['mkdir ' path]);\n" >> $mscript


for f in `ls acc0*csv`
do
    acc0=${f//.csv/}
    acc1=${acc0/acc0/acc1}

	echo "%% -----$acc0 $acc1------\n" >> $mscript
    echo "n_$acc0 = max($acc0.');" >> $mscript
    echo "n_$acc1 = max($acc1.');\n" >> $mscript
    echo "n = int64(length($acc0) * 6 / 7);" >> $mscript
    echo "maxval=0;\nmaxindex=1;" >> $mscript
    echo "\nfor m = 1:length($acc0)-n\ns=sum(n_$acc0(m:m+n-1));
    \nif(s>maxval)\nmaxval = s;\nmaxindex = m;
    \nend\nend\n" >> $mscript
    echo "p01 = n_$acc0(maxindex:maxindex+n-1)
    ./n_$acc1(maxindex:maxindex+n-1);" >> $mscript
    echo "p10 = n_$acc1(maxindex:maxindex+n-1)
    ./n_$acc0(maxindex:maxindex+n-1);\n" >> $mscript

	echo "figure(1)\nset(gca,'FontSize',16)
    \nplot(linspace(0,1000,n),p01);" >> $mscript
	echo "ylabel('acc0/acc1');\nxlabel('frequency (Hz)');
    \ntitle('acc0${acc1//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc0$acc1.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(2)\nset(gca,'FontSize',16)
    \nplot(linspace(0,1000,n),p10);" >> $mscript
	echo "ylabel('acc1/acc0');\nxlabel('frequency (Hz)');
    \ntitle('acc1${acc0//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc1$acc0.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(3)\nset(gca,'FontSize',16)" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc0(maxindex:maxindex+n-1,1)); 
    hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc0(maxindex:maxindex+n-1,2)); 
    hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc0(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');\n
    xlabel('frequency (Hz)');" >> $mscript
	echo "title('${acc0//_/\\_}');\n
    filename = strcat(path, '$acc0.png');\n
    saveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(4)\nset(gca,'FontSize',16);" >> $mscript
	echo "plot(linspace(0,1000,n), 
    $acc1(maxindex:maxindex+n-1,1)); 
    hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc1(maxindex:maxindex+n-1,2)); 
    hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc1(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');
    \nxlabel('frequency (Hz)');" >> $mscript
	echo "title('${acc1//_/\\_}');\n
    filename = strcat(path, '$acc1.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "close(figure(1));close(figure(2));
    close(figure(3));close(figure(4));\n" >> $mscript

done

#fscript=`pwd`/$mscript

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop 
-r "${mscript//.m/}"
\end{lstlisting}

\subsection{Original: $impact\_analysis\_baihan.sh$}\label{ss:ipc_ana.sh}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: impact analysis
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

folder=`pwd`
mscript=${folder//*\//}_impact_analysis_baihan.m
echo "% impact analysis.m for experiment 
${folder//*\//} \n% Baihan Lin, Apr 2017\n" > $mscript

echo "clear all; close all;" >> $mscript
echo "\nload('${folder//*\//}.mat')\n" >> $mscript
echo "path=('$folder/out/');\n
system(['mkdir ' path]);\n" >> $mscript


for f in `ls acc0*csv`
do
    acc0=${f//.csv/}
    acc1=${acc0/acc0/acc1}

	echo "%% -----$acc0 $acc1------\n" >> $mscript
	echo "time = 70;" >> $mscript
    echo "n_$acc0 = max($acc0.');" >> $mscript
    echo "n_$acc1 = max($acc1.');\n" >> $mscript
    echo "n = int64(length($acc0));" >> $mscript
    echo "maxval=0;\nmaxindex=1;" >> $mscript
    echo "\nfor m = 1:length($acc0)-n\ns=sum(n_$acc0(m:m+n-1));
    \nif(s>maxval)\nmaxval = s;\nmaxindex = m;\nend\nend\n" >> $mscript
    echo "p01 = n_$acc0(maxindex:maxindex+n-1)
    ./n_$acc1(maxindex:maxindex+n-1);" >> $mscript
    echo "p10 = n_$acc1(maxindex:maxindex+n-1)
    ./n_$acc0(maxindex:maxindex+n-1);\n" >> $mscript

	echo "figure(1)\nset(gca,'FontSize',16)\n
    plot(linspace(0,time,n),p01);" >> $mscript
	echo "ylabel('acc0/acc1');\nxlabel('t (s)');
    \ntitle('acc0${acc1//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc0$acc1.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(2)\nset(gca,'FontSize',16)
    \nplot(linspace(0,time,n),p10);" >> $mscript
	echo "ylabel('acc1/acc0');\nxlabel('t (s)');
    \ntitle('acc1${acc0//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc1$acc0.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(3)\nset(gca,'FontSize',16)" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc0(maxindex:maxindex+n-1,1)); hold on" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc0(maxindex:maxindex+n-1,2)); hold on" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc0(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');\nxlabel('t (s)');" >> $mscript
	echo "title('${acc0//_/\\_}');\n
    filename = strcat(path, '$acc0.png');\nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(4)\nset(gca,'FontSize',16);" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc1(maxindex:maxindex+n-1,1)); hold on" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc1(maxindex:maxindex+n-1,2)); hold on" >> $mscript
	echo "plot(linspace(0,time,n),
    $acc1(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');\nxlabel('t (s)');" >> $mscript
	echo "title('${acc1//_/\\_}');\nfilename = strcat(path, '$acc1.png');
    \nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "close(figure(1));close(figure(2));
    close(figure(3));close(figure(4));\n" >> $mscript

done

#fscript=`pwd`/$mscript

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop -r "${mscript//.m/}"
\end{lstlisting}

\subsection{Original: $spec\_analysis\_baihan.sh$}\label{ss:spc_ana.sh}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: spectrogram analysis
# Author: Baihan Lin
# Date: May 2017
# Lab: UbiComp Lab

folder=`pwd`
mscript=${folder//*\//}_spec_analysis_baihan.m
echo "% spectrogram analysis.m for experiment 
${folder//*\//} \n% Baihan Lin, May 2017\n" > $mscript

echo "clear all; close all;" >> $mscript
echo "\nload('${folder//*\//}.mat')\n" >> $mscript
echo "path=('$folder/spectrogram/');\n
system(['mkdir ' path]);\n" >> $mscript

for f in `ls acc0*csv`
do
    acc0=${f//.csv/}
    acc1=${acc0/acc0/acc1}

	echo "%% -----$acc0 $acc1------" >> $mscript
	echo "size = length($acc0);" >> $mscript
	echo "plane0 = var($acc0);" >> $mscript
	echo "plane1 = var($acc1);" >> $mscript
	echo "s_$acc0=zeros(size,1);" >> $mscript
	echo "s_$acc1=zeros(size,1);" >> $mscript
	
	echo "for n = 1:size" >> $mscript
    	echo "s_$acc0(n) = $acc0(n,:)
        *plane0.'/norm(plane0,2);" >> $mscript
    	echo "s_$acc1(n) = $acc1(n,:)
        *plane1.'/norm(plane1,2);" >> $mscript
	echo "end\n" >> $mscript

	echo "nwin = 100;" >> $mscript
	echo "wind = kaiser(nwin,10);" >> $mscript
	echo "nlap = nwin-10;" >> $mscript
	echo "nfft = 1024;" >> $mscript
	echo "Fs = 1/0.0003;\n" >> $mscript

	echo "figure(1)" >> $mscript
	echo "spectrogram(s_$acc0,wind,nlap,
    nfft,Fs,'yaxis')" >> $mscript
	echo "title('Spectrogram ${acc0//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 
    'spec_$acc0.png');" >> $mscript
	echo "saveas(gcf, filename,'png');" >> $mscript
	echo "close(figure(1));\n" >> $mscript

	echo "figure(2)" >> $mscript
	echo "spectrogram(s_$acc1,wind,nlap,
    nfft,Fs,'yaxis')" >> $mscript
	echo "title('Spectrogram ${acc1//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 
    'spec_$acc1.png');" >> $mscript
	echo "saveas(gcf, filename,'png');" >> $mscript
	echo "close(figure(2));" >> $mscript

	echo "figure(3)" >> $mscript
	echo "spectrogram(s_$acc0./s_$acc1,wind,
    nlap,nfft,Fs,'yaxis')" >> $mscript
	echo "title('Ratio Spectrogram acc0${acc1//_/\\_}');" >> $mscript
	echo "filename = strcat(path, '
    spec_ratio_acc0$acc1.png');" >> $mscript
	echo "saveas(gcf, filename,'png');" >> $mscript
	echo "close(figure(3));" >> $mscript
done

#fscript=`pwd`/$mscript

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop -r "${mscript//.m/}"

\end{lstlisting}


\subsection{Original: $impspec\_analysis\_baihan.sh$}\label{ss:imospc_ana.sh}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: impulse spectrogram analysis
# Author: Baihan Lin
# Date: May 2017
# Lab: UbiComp Lab

folder=`pwd`
mscript=${folder//*\//}_impspec_analysis_baihan.m
echo "% impulse spectrogram analysis.m for experiment 
${folder//*\//} \n% Baihan Lin, May 2017\n" > $mscript

echo "clear all; close all;" >> $mscript
echo "\nload('${folder//*\//}.mat')\n" >> $mscript
echo "path=('$folder/impulse_spectrogram/');\n
system(['mkdir ' path]);\n" >> $mscript

for f in `ls acc0*csv`
do
    acc0=${f//.csv/}
    acc1=${acc0/acc0/acc1}

	echo "%% -----$acc0 $acc1------" >> $mscript

	echo "pathN=(strcat(path,'$acc0','/'));" >> $mscript
	echo "system(['mkdir ' pathN]);\n" >> $mscript

	echo "set(0,'DefaultFigureVisible', 'off');\n" >> $mscript
	
	echo "size = length($acc0);" >> $mscript
	echo "plane0 = var($acc0);" >> $mscript
	echo "plane1 = var($acc1);" >> $mscript
	echo "s_$acc0=zeros(size,1);" >> $mscript
	echo "s_$acc1=zeros(size,1);\n" >> $mscript

	echo "pulse0 = zeros(size,1);" >> $mscript
	echo "pulse0(1:1000) = 1;" >> $mscript
	echo "pulse1 = zeros(size,1);" >> $mscript
	echo "pulse1(1:1000) = 1;\n" >> $mscript

	echo "rate = 0.0003;" >> $mscript
	echo "nwin = 100;" >> $mscript
	echo "wind = kaiser(nwin,10);" >> $mscript
	echo "nlap = nwin-10;" >> $mscript
	echo "nfft = 100;" >> $mscript
	echo "Fs = 1/rate;" >> $mscript
	echo "frame = 1000;\n" >> $mscript

	echo "for n = 1:size" >> $mscript
	echo "    s_$acc0(n) = $acc0(n,:)
    *plane0.'/norm(plane0,2);" >> $mscript
	echo "    s_$acc1(n) = $acc1(n,:)
    *plane1.'/norm(plane1,2);" >> $mscript
	echo "end\n" >> $mscript

	echo "plot(rate*[1:size],s_$acc0);" >> $mscript
	echo "title('calibrated signal for ${acc0//_/\\_}');" >> $mscript
	echo "xlabel('t(s)');" >> $mscript
	echo "ylabel('signal');" >> $mscript
	echo "filename = strcat(pathN, 'signal_$acc0.png');" >> $mscript
	echo "saveas(gcf, filename,'png');" >> $mscript

	echo "plot(rate*[1:size],s_$acc1);" >> $mscript
	echo "title('calibrated signal for ${acc1//_/\\_}');" >> $mscript
	echo "xlabel('t(s)');" >> $mscript
	echo "ylabel('signal');" >> $mscript
	echo "filename = strcat(pathN, 'signal_$acc1.png');" >> $mscript
	echo "saveas(gcf, filename,'png');" >> $mscript

	echo "for tp = frame+1:size-2*frame" >> $mscript
	echo "    if ~pulse0(tp) && (s_$acc0(tp) > 100)" >> $mscript
	echo "        spectrogram(s_$acc0(tp-frame:
    tp+frame*2),wind,nlap,nfft,Fs,'yaxis');" >> $mscript
 	echo "       title(strcat('Impulse spectrogram 
    ${acc0//_/\\_}','\_',int2str(tp)));" >> $mscript
	echo "        filename = strcat(pathN, strcat('impspec_',
    '$acc0','_',int2str(tp),'.png'));" >> $mscript
	echo "        saveas(gcf, filename,'png');" >> $mscript
	echo "        pulse0(tp:tp+frame*2) = 1;" >> $mscript
	echo "    end" >> $mscript
	echo "    if ~pulse1(tp) && (s_$acc1(tp) > 100)" >> $mscript
	echo "        spectrogram(s_$acc1(tp-frame:tp+frame*2),
    wind,nlap,nfft,Fs,'yaxis');" >> $mscript
	echo "        title(strcat('Impulse spectrogram 
    ${acc1//_/\\_}','\_',int2str(tp)));" >> $mscript
	echo "        filename = strcat(pathN, strcat('impspec_',
    '$acc1','_',int2str(tp),'.png'));" >> $mscript
	echo "        saveas(gcf, filename,'png');" >> $mscript
	echo "        pulse1(tp:tp+frame*2) = 1;" >> $mscript
	echo "    end" >> $mscript
	echo "end\n\n" >> $mscript
done

#fscript=`pwd`/$mscript

/Applications/Work/MATLAB_R2015b.app/
bin/matlab -nodesktop -r "${mscript//.m/}"
\end{lstlisting}


\subsection{Original: $apr21\_impact\_analysis\_baihan.m$}\label{ss:imp_ana.m}
\begin{lstlisting}
% analysis.m for experiment apr21 
% Baihan Lin, Apr 2017

clear all; close all;

load('apr21.mat')

path=('/Users/DoerLBH/Dropbox/git/UbiComp_OsteoApp_FEA/
raspberry_pi/osteoapp/apr21/out/');
system(['mkdir ' path]);

%% -----acc0_04_24_00_04_56 acc1_04_24_00_04_56------

n_acc0_04_24_00_04_56 = max(acc0_04_24_00_04_56.');
n_acc1_04_24_00_04_56 = max(acc1_04_24_00_04_56.');

n = int64(length(acc0_04_24_00_04_56) * 6 / 7);
maxval=0;
maxindex=0;

for m = 1:length(acc0_04_24_00_04_56)-n
s=sum(n_acc0_04_24_00_04_56(m:m+n-1));
if(s>maxval)
maxval = s;
maxindex = m;
end
end

p01 = n_acc0_04_24_00_04_56(maxindex:maxindex+n-1)
./n_acc1_04_24_00_04_56(maxindex:maxindex+n-1);
p10 = n_acc1_04_24_00_04_56(maxindex:maxindex+n-1)
./n_acc0_04_24_00_04_56(maxindex:maxindex+n-1);

figure(1)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),p01);
ylabel('acc0/acc1');
xlabel('frequency (Hz)');
title('acc0acc1\_04\_24\_00\_04\_56');
filename = strcat(path, 'pacc0acc1_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(2)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),p10);
ylabel('acc1/acc0');
xlabel('frequency (Hz)');
title('acc1acc0\_04\_24\_00\_04\_56');
filename = strcat(path, 'pacc1acc0_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(3)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,1)); hold on
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,2)); hold on
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,3));
ylabel('acceleration');
xlabel('frequency (Hz)');
title('acc0\_04\_24\_00\_04\_56');
filename = strcat(path, 'acc0_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(4)
set(gca,'FontSize',16);
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,1)); hold on
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,2)); hold on
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,3));
ylabel('acceleration');
xlabel('frequency (Hz)');
title('acc1\_04\_24\_00\_04\_56');
filename = strcat(path, 'acc1_04_24_00_04_56.png');
saveas(gcf, filename,'png');

close(figure(1));close(figure(2));
 close(figure(3));close(figure(4));
\end{lstlisting}
... (other sample similar to this)

\subsection{Original: $may14\_spec\_analysis\_baihan.m$}\label{ss:spc_ana.m}
\begin{lstlisting}
% spectrogram analysis.m for experiment may14 
% Baihan Lin, May 2017

clear all; close all;
load('may14.mat')

path=('/Users/DoerLBH/Dropbox/git/
UbiComp_OsteoApp_FEA/raspberry_pi/may14/spectrogram/');
system(['mkdir ' path]);

%% -----acc0_05_14_20_27_54 acc1_05_14_20_27_54------

size = length(acc0_05_14_20_27_54);
plane0 = var(acc0_05_14_20_27_54);
plane1 = var(acc1_05_14_20_27_54);
s_acc0_05_14_20_27_54=zeros(size,1);
s_acc1_05_14_20_27_54=zeros(size,1);

parfor n = 1:size
s_acc0_05_14_20_27_54(n) = acc0_05_14_20_27_54(n,:)
*plane0.'/norm(plane0,2);
s_acc1_05_14_20_27_54(n) = acc1_05_14_20_27_54(n,:)
*plane1.'/norm(plane1,2);
end

nwin = 100;
wind = kaiser(nwin,10);
nlap = nwin-10;
nfft = 1024;
Fs = 1/0.0003;

figure(1)
spectrogram(s_acc0_05_14_20_27_54,wind,nlap,nfft,Fs,'yaxis')
title('Spectrogram acc0\_05\_14\_20\_27\_54');
filename = strcat(path, 'spec_acc0_05_14_20_27_54.png');
saveas(gcf, filename,'png');
close(figure(1));

figure(2)
spectrogram(s_acc1_05_14_20_27_54,wind,nlap,nfft,Fs,'yaxis')
title('Spectrogram acc1\_05\_14\_20\_27\_54');
filename = strcat(path, 'spec_acc1_05_14_20_27_54.png');
saveas(gcf, filename,'png');
close(figure(2));

figure(3)
spectrogram(s_acc0_05_14_20_27_54
./s_acc1_05_14_20_27_54,wind,nlap,nfft,Fs,'yaxis')
title('Ratio Spectrogram acc0acc1\_05\_14\_20\_27\_54');
filename = strcat(path, 'spec_ratio_acc0acc1_05_14_20_27_54.png');
saveas(gcf, filename,'png');
close(figure(3));
\end{lstlisting}
... (other sample similar to this)

\subsection{Original: $may14\_impspec\_analysis\_baihan.m$}\label{ss:impspc_ana.m}
\begin{lstlisting}
% impulse spectrogram analysis.m for experiment may14 
% Baihan Lin, May 2017

clear all; close all;

load('may14.mat')

path=('/Users/DoerLBH/Dropbox/git/UbiComp_OsteoApp_FEA/
raspberry_pi/may14/impulse_spectrogram/');
system(['mkdir ' path]);

%% -----acc0_05_14_20_27_54 acc1_05_14_20_27_54------
pathN=(strcat(path,'acc0_05_14_20_27_54','/'));
system(['mkdir ' pathN]);

set(0,'DefaultFigureVisible', 'off');

size = length(acc0_05_14_20_27_54);
plane0 = var(acc0_05_14_20_27_54);
plane1 = var(acc1_05_14_20_27_54);
s_acc0_05_14_20_27_54=zeros(size,1);
s_acc1_05_14_20_27_54=zeros(size,1);

pulse0 = zeros(size,1);
pulse0(1:1000) = 1;
pulse1 = zeros(size,1);
pulse1(1:1000) = 1;

rate = 0.0003;
nwin = 100;
wind = kaiser(nwin,10);
nlap = nwin-10;
nfft = 100;
Fs = 1/rate;
frame = 1000;

for n = 1:size
    s_acc0_05_14_20_27_54(n) = acc0_05_14_20_27_54(n,:)
    *plane0.'/norm(plane0,2);
    s_acc1_05_14_20_27_54(n) = acc1_05_14_20_27_54(n,:)
    *plane1.'/norm(plane1,2);
end

plot(rate*[1:size],s_acc0_05_14_20_27_54);
title('calibrated signal for acc0\_05\_14\_20\_27\_54');
xlabel('t(s)');
ylabel('signal');
filename = strcat(pathN, 'signal_acc0_05_14_20_27_54.png');
saveas(gcf, filename,'png');
plot(rate*[1:size],s_acc1_05_14_20_27_54);
title('calibrated signal for acc1\_05\_14\_20\_27\_54');
xlabel('t(s)');
ylabel('signal');
filename = strcat(pathN, 'signal_acc1_05_14_20_27_54.png');
saveas(gcf, filename,'png');
for tp = frame+1:size-2*frame
    if ~pulse0(tp) && (s_acc0_05_14_20_27_54(tp) > 100)
        spectrogram(s_acc0_05_14_20_27_54(tp-frame:tp+frame*2),
        wind,nlap,nfft,Fs,'yaxis');
       title(strcat('Impulse spectrogram 
       acc0\_05\_14\_20\_27\_54','\_',int2str(tp)));
        filename = strcat(pathN, strcat('impspec_',
        'acc0_05_14_20_27_54','_',int2str(tp),'.png'));
        saveas(gcf, filename,'png');
        pulse0(tp:tp+frame*2) = 1;
    end
    if ~pulse1(tp) && (s_acc1_05_14_20_27_54(tp) > 100)
        spectrogram(s_acc1_05_14_20_27_54(tp-frame:tp+frame*2)
        ,wind,nlap,nfft,Fs,'yaxis');
        title(strcat('Impulse spectrogram 
        acc1\_05\_14\_20\_27\_54','\_',int2str(tp)));
        filename = strcat(pathN, strcat('impspec_',
        'acc1_05_14_20_27_54','_',int2str(tp),'.png'));
        saveas(gcf, filename,'png');
        pulse1(tp:tp+frame*2) = 1;
    end
end
\end{lstlisting}
... (other sample similar to this)

\subsection{Original: $replot\_baihan.sh$}\label{ss:replot}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: replot analysis
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

# use in individual folder

grep csv list.txt | grep acc1 | cut -c 46-59 > uniqlist.txt

cp -r out out_replot
cd out_replot
mkdir forTex

i=1
for f in `cat ../uniqlist.txt`
do
	convert *$f* +append tex_$f.png
	cp tex_$f.png forTex/t2_$i.png
	mkdir $f/;
	mv *$f.png $f/
	let i+=1
done

rm *.png
cd ../
\end{lstlisting}

\subsection{Original: $may30\_fft\_lsq\_delay.m$}\label{ss:delay}
\begin{lstlisting}
% time delay analysis with FFT and least Sq. may30
% Baihan Lin, June 2017

clear all; close all;

path='/Users/DoerLBH/Dropbox/git/
UbiComp_OsteoApp_FEA/audio_time_delay/may30/';
pathG='/Users/DoerLBH/Dropbox/git/
UbiComp_OsteoApp_FEA/audio_time_delay/';

[y,fs] = audioread(strcat(path,'DR0000_0015.wav'));

ch1 = y(:,1);
ch2 = y(:,2);
ch1_fft = real(fft(y(:,1)));
ch2_fft = real(fft(y(:,2)));
save(strcat(pathG,'data1'));

dt = 1/fs;
t = 0:dt:(length(y)*dt)-dt;

%% plotting

figure(1);

subplot(2,2,1);
plot(t,ch1);
xlabel('Seconds');
ylabel('Amplitude');
title('ch1');

subplot(2,2,2);
plot(t,ch2);
xlabel('Seconds');
ylabel('Amplitude');
title('ch2');

subplot(2,2,3);
plot(t,ch1_fft);
xlabel('Seconds');
ylabel('Amplitude');
title('ch1-fft');

subplot(2,2,4);
plot(t,ch2_fft);
xlabel('Seconds');
ylabel('Amplitude');
title('ch2-fft');

%% fminsearch method

c0 = 0;
cr = fminsearch('eFlsq1', c0)

%% iterative method (worked)

range = 200;
min = 10e+20;
td_fft = 0;
td = 0;

for c = 0:range
    err = 0.0;
    for j = range : length(ch1)-range;
        err = err + (ch1_fft(j+round(c)) - ch2_fft(j))^2;
    end
    err;
    if err < min
        min = err;
        td_fft = c;
    end  
end
td_fft

for c = 0:range   
    err = 0.0;
    for j = range : length(ch1)-range;
        err = err + (ch1(j+round(c)) - ch2(j))^2;
    end
    err;
    if err < min
        min = err;
        td = c;
    end
end
td
\end{lstlisting}

\subsection{Modified: $spectrogram\_baihan.py$}\label{ss:specPy}
\begin{lstlisting}
#!/usr/bin/python
# -*- coding: utf-8 -*-
# Baihan Lin, 2017

import matplotlib.pyplot as plt
import numpy as np
import sys
from itertools import islice

dt = 0.0003
allTime = 66.0
sampleSize = 220001

for arg in sys.argv:
	filename = arg

x=[]
y=[]
z=[]
with open(filename) as myfile:
    data = list(islice(myfile, sampleSize))
    for line in data:
        x.append(line.split()[0])
        y.append(line.split()[1])
        z.append(line.split()[2])

t = np.arange(0.0, allTime, dt)
#s1 = np.sin(2*np.pi*100*t)
#s2 = 2*np.sin(2*np.pi*400*t)

# create a transient "chirp"
#mask = np.where(np.logical_and(t > 10, t < 12), 1.0, 0.0)
#s2 = s2 * mask

# add some noise into the mix
#nse = 0.01*np.random.random(size=len(t))

#x = s1 + s2 + nse  # the signal
NFFT = 1024       # the length of the windowing segments
Fs = int(1.0/dt)  # the sampling frequency

# Pxx is the segments x freqs array of instantaneous power, freqs is
# the frequency vector, bins are the centers of the time bins in which
# the power is computed, and im is the matplotlib.image.AxesImage
# instance

ax1 = plt.subplot(231)
plt.plot(t, x)
plt.subplot(234, sharex=ax1)
Pxx, freqs, bins, im = plt.specgram(x, NFFT=NFFT, Fs=Fs, noverlap=900)

ax2 = plt.subplot(232)
plt.plot(t, y)
plt.subplot(235, sharex=ax2)
Pxx, freqs, bins, im = plt.specgram(y, NFFT=NFFT, Fs=Fs, noverlap=900)

ax3 = plt.subplot(233)
plt.plot(t, z)
plt.subplot(236, sharex=ax3)
Pxx, freqs, bins, im = plt.specgram(z, NFFT=NFFT, Fs=Fs, noverlap=900)

plt.savefig(filename.replace("csv", "png"))
plt.show()
\end{lstlisting}

\subsection{Referenced: $daisychain\_baihan.py$}\label{ss:daisy}
\begin{lstlisting}
#!/usr/bin/python
# -*- coding: utf-8 -*-
# Example on how to read the ADXL345 accelerometer.
# Kim H. Rasmussen, 2014
# modified by Baihan Lin, 2017

import time
import spidev
import math
#import sys, select, os
import RPi.GPIO as GPIO
#import spi
import sys, select, os
import cPickle as pickle

time_run = 70
folder = "apr21"

counter0 = 0
counter1 = 0

GPIO.setmode(GPIO.BOARD)
GPIO.setup(22, GPIO.IN, pull_up_down=GPIO.PUD_UP)
#GPIO.setup(18, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# SETUP SPIs
spi1 = spidev.SpiDev()
spi1.open(0,1)

spi0 = spidev.SpiDev()
spi0.open(0,0)

def setup_spi(spi) :
    spi.mode = 3 # <-- make sure to set mode AFTER open
    spi.max_speed_hz = 5000000 # 3.9MHz < 5MHz 
    (highest value for adxl345), 3.9MHz is 
    equivalent to clock divisor of 64

setup_spi(spi1)
setup_spi(spi0)

# Read the Device ID (should be xE5)
# xfer transfers varying control select, 
but xfer2 cs will be held active
id = spi1.xfer2([128,0])
print 'Device ID (Should be 0xe5):\n'+str(hex(id[1])) + '\n'
id = spi0.xfer2([128,0])
print 'Device ID (Should be 0xe5):\n'+str(hex(id[1])) + '\n'

# open file to write data to
fname = time.strftime("%m_%d_%H_%M_%S", time.gmtime())
fname0 = folder + "/acc0_" + fname + ".pkl"
fname1 = folder + "/acc1_" + fname + ".pkl"
#print fname
f0 = open(folder + "/acc0_" + fname + ".pkl", "wb")
f1 = open(folder + "/acc1_" + fname + ".pkl", "wb")
#f0_string = "x_acc\ty_acc\tz_acc\n"
#f1_string = "x_acc\ty_acc\tz_acc\n"
f0_list = []
f1_list = []

# Initialize the ADXL345
def initadxl345(spi):
    # Enter power saving state
    spi.xfer2([45, 0]) # [0x2d, 0x00]

    # Set data rate to 3200 hz (rate code 0x0f) and not low power
    spi.xfer2([44, 15]) # [0x2c, 0x0f]

    # I didnt enable full range (sets number of bits) 
    and set range to +/- 2g 
    # also sets to 4-wire spi
    #spi.xfer2([49, 0]) # [0x31, 0x00]
    #spi.xfer2([49, 0]) # [0x31, 0x00]
    #spi.xfer2([49, 10]) # [0x31, 0x00]
    spi.xfer2([49, 11]) # [0x31, 0b00001011] 
    which means +-16g and full resolution
    

    #should probably set all to zero:
    #FIFO_CTL
    spi.xfer2([56, 0]) # 0x38, 0x00
    #ACT_INACT_CTL -- "If all axes are excluded, 
    the function is disabled" d6, d5, d4
    spi.xfer2([39, 0]) # 0x27, 0x00
    #TAP_AXES
    spi.xfer2([42, 0]) # 0x2a, 0x00

    # set all offsets to 0
    spi.xfer2([30,0])
    spi.xfer2([31,0])
    spi.xfer2([32,0])

    # set DATA_READY interrupt in INT_ENABLE, 
    automatically set to active-high
    spi.xfer2([46, 128]) # [0x2e, 0x80]
    # set INT_MAP to enable interrupts on int1 
    by setting the 0x80 bit to 0
    spi.xfer2([47, 0]) # [0x2f, 0x0]

    # Enable measurement
    spi.xfer2([45, 8]) # [0x2d, 0x08]

# Read the ADXL x-y-z axia
def readadxl345(spi):
    rx = spi.xfer2([242,0,0,0,0,0,0]) # 0xf2
    #print rx

    out = [rx[1] | (rx[2] << 8),rx[3] | 
    (rx[4] << 8),rx[5] | (rx[6] << 8)]
    # Format x-axis
    if (out[0] & (1<<15)):
        out[0] = out[0] - (1<<16)
    #out[0] = out[0] * 9.82 / 256
    # Format y-axis
    if (out[1] & (1<<15)):
        out[1] = out[1] - (1<<16)
    #out[1] = out[1] * 9.82 / 256
    # Format z-axis
    if (out[2] & (1<<15)):
        out[2] = out[2] - (1<<16)
    #out[2] = out[2] * 9.82 / 256
    #print out

    return out

def read_save0(channel):
    #read_save(spi0, f0_string)
    #global f0_string
    global counter0
    axia = readadxl345(spi0)
    counter0 += 1
    pickle.dump(axia, f0)

    axia = readadxl345(spi1)
    pickle.dump(axia, f1)

#def read_save1(channel):
    #read_save(spi1, f1_string)

#def read_save(spi, f_string):
#    axia = readadxl345(spi)
#    f_string = f_string + str(axia[0]).
zfill(5) + "\t" + str(axia[1]).zfill(5) + "\t" + str(axia[2]).zfill(5) + "\n"

# Initialize the ADXL345 accelerometer
initadxl345(spi1)
initadxl345(spi0)

timeout = time.time() + time_run

# Create callback for interrupt (Read the ADXL345)
#GPIO.add_event_detect(18, GPIO.RISING, callback=read_save1)
GPIO.add_event_detect(22, GPIO.RISING, callback=read_save0) 

# read once to fix interrupt... (clears the current interrupt)
#rx = readadxl345(spi1)
rx = readadxl345(spi0)

time.sleep(time_run)

GPIO.cleanup()
time.sleep(1)
f0.close()
f1.close()

print(counter0/time_run)
#print(counter1/time_run)

f0_csv = open(folder + "/acc0_" + fname + ".csv", "w")
pickledtext = []
file0 = open(fname0, "rb")
l = []
while 1:
    try :
        line = pickle.load(file0)
        #print line
        l.append("\t".join(str(x) for x in line))
    except EOFError:
        break
f0_csv.write("\n".join(l))
f0_csv.close()
#f0.close()

f1_csv = open(folder + "/acc1_" + fname + ".csv", "w")
pickledtext = []
file1 = open(fname1, "rb")
l = []
while 1:
    try :
        line = pickle.load(file1)
        #print line
        l.append("\t".join(str(x) for x in line))
    except EOFError:
        break
f1_csv.write("\n".join(l))
f1_csv.close()
\end{lstlisting}


\section{Acknowledgments}

Thank Prof. Shwetak Patel for the opportunity to join this exciting lab and work on this meaningful project. Thank Morelle Arian and Josh Fromm for the patient guidance and faith in me through the project. Thank UbiComp Lab members such as Joshua Lim and Edward Wang for helpful advice and support. Thank Xinxin Zhang, Hongtao Wu, Yuxin Fu, Che Yi and Ziwen Guo for helpful discussion in mechanical engineering, material science and electrical engineering. Thank University of Washington for the wonderful platforms and resources in electrical engineering, mechanical engineering and computer science. I wouldn't be able to surpass many difficult challenges without their consistent supports.

\balance{}


% REFERENCES FORMAT
% References must be the same font size as other body text.
\bibliographystyle{SIGCHI-Reference-Format}
\bibliography{sample}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:


\documentclass{sigchi}

% Use this command to override the default ACM copyright statement
% (e.g. for preprints).  Consult the conference website for the
% camera-ready copyright statement.

%% EXAMPLE BEGIN -- HOW TO OVERRIDE THE DEFAULT COPYRIGHT STRIP -- (July 22, 2013 - Paul Baumann)
% \toappear{Permission to make digital or hard copies of all or part of this work for personal or classroom use is      granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page. Copyrights for components of this work owned by others than ACM must be honored. Abstracting with credit is permitted. To copy otherwise, or republish, to post on servers or to redistribute to lists, requires prior specific permission and/or a fee. Request permissions from permissions@acm.org. \\
% {\emph{CHI'14}}, April 26--May 1, 2014, Toronto, Canada. \\
% Copyright \copyright~2014 ACM ISBN/14/04...\$15.00. \\
% DOI string from ACM form confirmation}
%% EXAMPLE END -- HOW TO OVERRIDE THE DEFAULT COPYRIGHT STRIP -- (July 22, 2013 - Paul Baumann)

% Arabic page numbers for submission.  Remove this line to eliminate
% page numbers for the camera ready copy
% \pagenumbering{arabic}

% Load basic packages
\usepackage{balance}  % to better equalize the last page
\usepackage{graphics} % for EPS, load graphicx instead 
\usepackage[T1]{fontenc}
\usepackage{txfonts}
\usepackage{mathptmx}
\usepackage[pdftex]{hyperref}
\usepackage{color}
\usepackage{booktabs}
\usepackage{textcomp}
% Some optional stuff you might like/need.
\usepackage{microtype} % Improved Tracking and Kerning
% \usepackage[all]{hypcap}  % Fixes bug in hyperref caption linking
\usepackage{ccicons}  % Cite your images correctly!
% \usepackage[utf8]{inputenc} % for a UTF8 editor only

\usepackage{chemformula}
\usepackage{booktabs,amsmath}
\usepackage[utf8]{inputenc}
\usepackage{array}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{placeins}
\usepackage{float}
\usepackage{amssymb}
\usepackage{pdfpages}
\usepackage{chemformula}
\usepackage{amsmath}
\usepackage{caption}
\usepackage{subcaption}
%\usepackage{subfig}

% If you want to use todo notes, marginpars etc. during creation of your draft document, you
% have to enable the "chi_draft" option for the document class. To do this, change the very first
% line to: "\documentclass[chi_draft]{sigchi}". You can then place todo notes by using the "\todo{...}"
% command. Make sure to disable the draft option again before submitting your final document.
\usepackage{todonotes}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

% Paper metadata (use plain text, for PDF inclusion and later
% re-using, if desired).  Use \emtpyauthor when submitting for review
% so you remain anonymous.
\def\plaintitle{SIGCHI Conference Proceedings Format}
\def\plainauthor{First Author, Second Author, Third Author,
  Fourth Author, Fifth Author, Sixth Author}
\def\emptyauthor{}
\def\plainkeywords{Authors' choice; of terms; separated; by
  semicolons; include commas, within terms only; required.}
\def\plaingeneralterms{Documentation, Standardization}

% llt: Define a global style for URLs, rather that the default one
\makeatletter
\def\url@leostyle{%
  \@ifundefined{selectfont}{
    \def\UrlFont{\sf}
  }{
    \def\UrlFont{\small\bf\ttfamily}
  }}
\makeatother
\urlstyle{leo}

% To make various LaTeX processors do the right thing with page size.
\def\pprw{8.5in}
\def\pprh{11in}
\special{papersize=\pprw,\pprh}
\setlength{\paperwidth}{\pprw}
\setlength{\paperheight}{\pprh}
\setlength{\pdfpagewidth}{\pprw}
\setlength{\pdfpageheight}{\pprh}

% Make sure hyperref comes last of your loaded packages, to give it a
% fighting chance of not being over-written, since its job is to
% redefine many LaTeX commands.
\definecolor{linkColor}{RGB}{6,125,233}
\hypersetup{%
  pdftitle={\plaintitle},
% Use \plainauthor for final version.
%  pdfauthor={\plainauthor},
  pdfauthor={\emptyauthor},
  pdfkeywords={\plainkeywords},
  bookmarksnumbered,
  pdfstartview={FitH},
  colorlinks,
  citecolor=black,
  filecolor=black,
  linkcolor=black,
  urlcolor=linkColor,
  breaklinks=true,
}

% create a shortcut to typeset table headings
% \newcommand\tabhead[1]{\small\textbf{#1}}

% End of preamble. Here it comes the document.
\begin{document}

\title{Project Report: Finite Element Analysis for OsteoApp}

\numberofauthors{3}
\author{%
  \alignauthor{Baihan Lin\\
    \affaddr{UbiComp Lab}\\
    \affaddr{University of Washington}\\
    \affaddr{Seattle, WA 98105, USA}\\
    \email{doerlbh@gmail.com}}\\
}

\maketitle

\begin{abstract}
The project aims to conduct a finite element analysis (FEA) on a bone-like structure to simulate the vibration properties of a bone or arm. This simulation is supportive to OsteoApp, a smartphone app for personal osteoporosis screening that tests bone density and tells people if they are at risk for bone disease. OsteoApp uses a vibration technique that takes advantage of the accelerometers on a hand-held smartphone to measure bone stiffness and density, based on the vibrations that pass through the user's arm when the elbow is tapped. The FEA simulation in this study can help us better understand the relationship between the external tapping with the measured signals. This study is conducted by Baihan Lin, mentored by Morelle Arian and Josh Fromm, and supervised by Prof. Shwetak Patel.

\end{abstract}

\category{H.5.m.}{Information Interfaces and Presentation
 (e.g. HCI)}{Miscellaneous}{}{}

\keywords{signal processing, ubiquitous computing, health sensing, mobile phones, osteoporosis screening, finite elements analysis}

\section{Introduction}

Osteoporosis is a disease where increased bone weakness increases the risk of a broken bone. OsteoApp aims to utilize the accelerometers on a hand-held smartphone to measure bone strength, based on the vibrations that pass through the user's arm when the elbow is tapped. To facilitate the understanding of the relationship between the external tapping with the measured signals, finite element analysis (FEA) is applied, as a computerized method for predicting how a product reacts to real-world forces, vibration, heat, fluid flow, and other physical effects. The study aims to understand the information that accelerometers may be collecting based on the simulated properties of the bone-like structures. \\

The study plans for three stages:
\begin{itemize}
\item simulate a simplified bone-like structure
\item simulate the bone with more details and less assumptions
\item formulate the equations of the signal properties
\newline
\end{itemize}

For each bone models, several FEA analyses can be conducted:
\begin{itemize}
\item static stress analysis
\item natural frequency analysis
\item drop test analysis with rigid impact
\item drop test analysis with flexible impact
\item drop test analysis with damping effect
\item linear dynamic modeling with modal damping 
\end{itemize}

\section{Progress} 

UPDATE-\today: Currently, I have conducted multiple simulations for a simplified combined model of bones (a wooden complex combining two bent rods). I also created the basic formula of the natural frequency of the bone. I experimentally tested the signal generated by accelerator under a frequency sweep as well as explored the possibility of measuring the elasticity of wood.

\subsection{2017/03/30: Interview and Setup}

Morelle warmly introduced me to the project and we briefly discussed the general idea of the OsteoApp project as well as its current state. 

\subsection{2017/04/04: Decide on project}

Josh, Morelle and I discussed about the two directions of the supporting simulation analysis for OsteoApp. We decided that there are two major directions: one is to simulate the entire finite element analysis in SolidWorks; the other is to biophysically define and formulate the possible equations of bone vibration based on the limited physical properties of bone structures. 
After some discussion, we finally decided to start from SolidWorks simulations and later march towards mathematical formulation which is more creative and challenging.

\subsection{2017/04/11: Basic construction of model}

As shown in Figure~\ref{fig:arm_diagram} from $Grey's$ $Anatomy$ \cite{WikipediaEN:Arm}, the humerus is the (upper) arm bone which joins with the scapula above at the shoulder joint (or glenohumeral joint) and with the ulna and radius below at the elbow joint. The entire structure of bones is rather complicated considering the twisted and combined configuration.


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/human_arm_bones_diagram}
  \caption{Bones of the upper limbs, together with shoulder girdles together comprising the human arm}~\label{fig:arm_diagram}
\end{figure}


To simplify the arm structure, I first use femur bone model from GrabCAD \cite{SB:bone} for my initial simulation, with its shape shown and its mass properties shown in Figure \ref{fig:femur_property}. However, later I found that the calculation by SolidWorks took several hours for even the simplest simulation. I attributed this issue as the complexity of the real bone structure as well as its fine mesh mapping. 


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/femur_property}
  \caption{the femur model and its mass properties }~\label{fig:femur_property}
\end{figure}


Therefore, I created a 3D model of a simplified double bone of ulna and radius combined, shown in Figure \ref{fig:double_bone}. To create the bone, I assume an average adult has ulna and radius bone with an approximately 20mm in diameter each and 300mm in length with a flex of 15 degrees. I combined them together with a shared diameters of 2mm from the flex. 


\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/double_bone}
  \caption{the double bone model}~\label{fig:double_bone}
\end{figure}


For the material selection applied for simulations, the bones are not fully solid but made up of a network of matter with pores. In addition, most of the largest bones are hollow and each bone also contains blood vessels, nerve cells and living bone cells known as osteocytes. These are held together by a framework of hard, non-living material containing calcium and phosphorous. A thin membrane called the periosteum covers the surface of your bones. Based on different density, bone can either be spongy or compact. Therefore, I suppose the nearest to bone would be a composite of some sort or hard-wood, because trunks also consist of cells with cell walls like bone structures. From the material categories, I chose balsa wood as the structure with properties shown in Figure \ref{fig:db_balsa}.

\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/db_balsa}
  \caption{the material properties of balsa wood applied to the designed double bone model}~\label{fig:db_balsa}
\end{figure}

\subsubsection{Static stress analysis}

With a fixed point on the top of the bone as a hand holding smartphone, the simulation exert a static 20N force in a direction normal to the bottom of the combined double bone model, resembling the movement of tapping the elbow.

The static stress analysis doesn't inform much about frequency signals. However, as shown in Figure \ref{fig:db_stat_ana}, it offers helps information on the biggest strain of the model, which can also be the noisiest location to collect signals. This can possibly imply the evaluation of signal qualities based on certain posture of holding the phone.


\begin{figure*}
\centering
  \includegraphics[width=1.95\columnwidth]{figures/db_stat_ana}
  \caption{the static stress analysis of the double bone model in (a) stress, (b) displacement and (c) strain.}~\label{fig:db_stat_ana}
\end{figure*}


\subsubsection{Natural frequency analysis}

Natural Frequencies are the fundamental frequencies whose multiples are called "harmonics". The model structures tend to vibrate with a particular mode shape at each frequency. Dynamic loads coinciding with a natural frequency can cause resonance. Therefore, we can measure its natural frequency as a potential signal indicator via resonance. Damping exists in real structures to limit the response.

It is also noted that, natural frequencies and mode shapes depend on geometry, material properties and mass, support conditions (fixtures) and in-plane loads. Many of these factors have been simplified by assumptions which can be different from a real bone structures. Thus, further study can be conducted to explore these factors. In addition, real structures have infinite numbers of natural frequencies and modal shapes, but in finite element models we use, they only have a finite number.

The simulation indicates a wide variety of possible harmonic vibrations, as shown from Figure \ref{fig:db_freq1}. The relationship of mode number with natural frequencies were not purely linear, demonstrated by Table \ref{tab:db_freq} and Figure \ref{fig:db_freq1_graph1}.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_freq1}
  \caption{natural frequency analysis for double bone}
    ~\label{fig:db_freq1}
\end{figure*}

\begin{table}
  \centering
  \begin{tabular}{l r r r}
    % \toprule
    & & \multicolumn{2}{c}{\small{\textbf{Frequency}}} \\
    \cmidrule(r){3-4}
    {\small\textit{Mode No.}}
    & {\small \textit{Period (s)}}
      & {\small \textit{(Rad/s)}}
    & {\small \textit{(Hertz)}} \\
    \midrule
    1 & 0.0076324 & 823.23 & 131.02 \\
    2 & 0.0051459 & 1221 & 194.33 \\
    3 & 0.0014234 & 4414.1 & 702.53 \\
    4 & 0.0012319 & 5100.4 & 811.76 \\
    5 & 0.0011668 & 5384.9 & 857.04 \\
    % \bottomrule
  \end{tabular}
  \caption{natural frequencies in different modes for double bone model}~\label{tab:db_freq}
\end{table}

\begin{figure}
\centering
  \includegraphics[width=0.9\columnwidth]{figures/db_freq1_graph1}
  \caption{natural frequency vs. mode number for double bone}~\label{fig:db_freq1_graph1}
\end{figure}


\subsubsection{Drop test analysis with rigid impact}

In a drop test analysis, the time varying stresses and deformations due to an initial impact of the product with a rigid or flexible planar surface (the floor) are calculated. I found this simulation interesting because the idea of tapping elbow resembles dropping the elbow on a desk or hand. 

I found another variable very useful that is generated in the analysis, "Translational Acceleration" in $mm/s^2$, because I think this signal could potentially resemble the signal sensed by the accelerometers in smartphones.

In Drop Test 1, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0. I also consider it to drop to a stiff surface, so I set target stiffness = rigid, with result shown in Figure \ref{fig:db_dt1_ana}. 

Interestingly, if we consider the time graph of the translational acceleration (Figure \ref{fig:db_dt1_res}) as described previously, we can see that the signals have their unique patterns. Node 1 and 2 were both collected at the very end, and they responded different from Node 7 in a more middle position.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt1_ana}
  \caption{analysis for Drop Test 1 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt1_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt1_res}
  \caption{response graphs for Drop Test 1 for double bone in three different location (nodes).}
    ~\label{fig:db_dt1_res}
\end{figure*}

\subsubsection{Drop test analysis with flexible impact}

In Drop Test 2, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0. I also consider it to drop to a flexible surface, so I set target stiffness = flexible, with result shown in Figure \ref{fig:db_dt2_ana}. 

I found this case interesting because this resembles the tapping of elbow by hand palm which is a flexible surface with certain thickness. From the animation I also observe such absorption of vibrations and delay of transduction.

If we consider the time graph of the translational acceleration (Figure \ref{fig:db_dt2_res}), we can see that the signals are in fact very different from the Drop Test 1 in the same locations. This implies that the material of the tapping objects is a very important factor in the signal identification.

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt2_ana}
  \caption{analysis for Drop Test 2 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt2_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt2_res}
  \caption{response graphs for Drop Test 2 for double bone in three different location (nodes).}
    ~\label{fig:db_dt2_res}
\end{figure*}


\subsubsection{Drop test analysis with damping effect}

In Drop Test 3, the bone vertically drop at 5m/s with gravity considered. In this case, I consider the system without damping, so I set contact damping = 0.5. I also consider it to drop to a stiff surface, so I set target stiffness = rigid, with result shown in Figure \ref{fig:db_dt3_ana}, which is very similar to Drop Test 1. Such similarity also arises in the time graph of the translational acceleration (Figure \ref{fig:db_dt3_res}). Arguably speaking, this doesn't support the importance of damping effect in signal feature extraction later in OsteoApp development. 

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt3_ana}
  \caption{analysis for Drop Test 3 for double bone in (a) stress, (b) displacement and (c) strain.}
    ~\label{fig:db_dt3_ana}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/db_dt3_res}
  \caption{response graphs for Drop Test 3 for double bone in three different location (nodes).}
    ~\label{fig:db_dt3_res}
\end{figure*}

\subsection{2017/04/18: Frequency Propagation of double bone model}

After discussion, we decided to expand the analysis into a design where the vibration signal of a certain frequency is provided at one end of the bone. This is to simulate a proposed engineering design that the user put his or her arm onto the surface of a smart phone which generates a certain frequency, then another smart phone, held in the hand of the arm, records the propagated frequencies with accelerators to determine the bone density.

Therefore, instead of the original design where only one impulse is provided, a constant vibration of a certain frequency is provided. There are no obvious built-in SolidWorks package to facilitate this design, but I found "Linear Dynamic Simulation", which uses frequencies and mode shapes to study linear response to dynamic loading, promising for our analysis.

\subsubsection{Linear dynamic modeling of frequency propagation} 

Earlier, I was trying to perform linear dynamic modeling would be a very interesting simulation because it can take into account the impact of a ball towards the bone, which can support an existing measurement equipment in the lab. Unfortunately, when I was running the simulations, the SolidWorks crashed several times and never made to the end. I will re-attempt this simulation. The following is to simulate the frequency propagation.

I attempted to create a harmonic dynamic simulation. In doing so, one essential step is to create a periodic force as the constant impulse and record the time steps of the propagation. Searching for different resources, I found it currently infeasible for such task. Consulting several friends in mechanical engineering and material sciences, they suggest that SolidWorks was mostly used for model design and ANSYS is the common software for simulations, so I decide to switch gear to ANSYS.

\subsubsection{FEA with ANSYS} 

ANSYS is only available through ME departmental access in the remote desk top. To specify material properties of the bone, there is only one built-in material available in their package, thus, when specifying a new type of material, I defined the density to be 1900 $kg/m^3$ from \cite{Cameron:1999:Physics}. So far, the ANSYS simulation has not been fully finished yet. 

However, in the midst, some of my friends in mechanical engineering let me know that such simulation, even done by ANSYS, will be very difficult if possible as all. Normally, they would just use a vibrator and experiment on the material itself through manual frequency tuning instead of simulation. 

\subsubsection{Cogitation about the propagation process} 

Let's take a step back and think of the process, as shown in equation \eqref{eq:mot1}\eqref{eq:mot2}, an external frequency input would not observe a change in frequency when propagation. The propagation created a phase change and uneven amplitude due to resonance of the material. 

How to define the density of a material, in our case, the bone, is more or less related to the natural frequency of the material. In our experimental design, the way to experimentally determine the frequency is to exert an external frequency changing within a wide range and find the biggest amplitude recorded, which would be the natural frequency which causes resonance.  

\subsubsection{Initial formulation of the frequency analysis} 

Mechanical impedance is a measure of how much a structure resists motion when subjected to a harmonic force. The motion function can be formulated as:

\begin{equation} \label{eq:mot1}
mx''+cx'+kx=f(t)={\bf F}e^{jwt}
\end{equation}

where $f(t)$ is the external force with a harmonic oscillation. Thus, the corresponding harmonic oscillation induced by the external force: 

\begin{equation} \label{eq:mot2}
x={\bf X}e^{j\omega t}, x'={\bf V}e^{j \omega t}=j\omega{\bf X}e^{j\omega t}, x''={\bf A}e^{j \omega t}=-\omega^2{\bf X}e^{j \omega t}
\end{equation}

From many aspect, our question is very similar to the classic beam question. There are several predefined properties discovered in the beam studies which could offer insights into our analysis. If we consider the bone as a beam, for example, a cantilever beam (because one end is attached to the smart phone as a fixed point), then its natural frequency can be expressed by the following \cite{Young:2002:formula}:

\begin{equation} \label{eq:beam}
f_1=\frac{\alpha_1^2}{L^2}\sqrt[]{\frac{EI}{w}}=\frac{\alpha_1^2}{L^2}\sqrt[]{\frac{EI}{\rho A}} 
\end{equation}

where $f_1$ is the natural frequency of the cantilever beam (bone) with uniform load $w$ per unit length including beam (bone) weight; $L$ is the length of the beam (bone); $E$ is the modulus of elasticity of the material; $I$ is the area moment of inertia, a geometrical parameter based on the intersection of the beam (bone); and normally, we take constant $\alpha_1 = 1.875$.

What is interesting in this formula is how bone structure can be specified differently here. The area of inertia can be different as the structural properties of the bone is a porous complex. I can try treating each individual pore as one unit and sum them up together. In addition, the elasticity of the bone is relatively undefined. Other than calculation, another more direct way would be to do an elasticity measurement of a real bone. 
 
The real application in OsteoApp would have more to consider. Not only in our formula it displays that length of arm is a factor to determine natural frequency (something to be collected during user experiments). Moreover, with the addition of muscle, it would be two separate materials instead of one. In that analysis, we need to calculate two natural frequencies separately and combine their amplitudes together to be our estimated signal during measurements. 

\subsection{2017/04/23: Experiment and measurements}

I experimentally tested the signal generated by accelerator under a frequency sweep as well as explored the possibility of measuring the elasticity of wood. 

\subsubsection{How to measure the modulus of elasticity} 

From the equation \eqref{eq:beam} of natural frequency for cantilever beam, $E$ is the modulus of elasticity of the material. How can we measure the modulus of elasticity? Young's modulus, also known as the elastic modulus, is a measure of the stiffness of a solid material. It is a mechanical property of linear elastic solid materials. It defines the relationship between stress (force per unit area) and strain (proportional deformation) in a material. The velocity measurements for modulus calculation are most commonly made with precision thickness gages such as models 38DL PLUS (Figure \ref{fig:plastic-modulus}) and 45MG with Single Element software,  or a flaw detector with velocity measurement capability such as the EPOCH series instruments. Pulser/receivers such as the Model 5072PR or 5077PR can also be used with an oscilloscope or waveform digitizer for transit time measurements. 

\begin{figure}
\centering
  \includegraphics[width=0.5\columnwidth]{figures/plastic-modulus}
  \caption{Olympus 38DL PLUS}~\label{fig:plastic-modulus}
\end{figure}

However, another viable option for our modeling, is that I found a measured number for Young's modulus of the bone. For example, Young's modulus of trabecular and cortical bone material is available by Ultrasonic and microtensile measurements \cite{boneYoung} as 14.8 GPa (S.D. 1.4) and 10.4 (S.D. 3.5) for trabecular bone and 20.7 GPa (S.D. 1.9) and 18.6 GPa (S.D. 3.5) for cortical bone.

\subsubsection{Frequency sweep experiment via raspberry pi} 

The frequency sweep was set as a linear sweep from 0 to 1000Hz in a time range of 60 seconds. Thus, in the data collection of accelerometers via raspberry pi, I set the time collection to be 70 seconds (see referenced code daisychain\_baihan.py). I performed 4 experiments each with 5 runs (Figure \ref{fig:pose} and Table \ref{tab:sweep}): 
\begin{itemize}
\item 5 times with accelerometer facing the vibrator (pose 1)
\item 5 times with accelerometer backing the vibrator (pose 2)
\item 5 times with the rod's bottom being vibrated (pose 3)
\item 5 times with accelerometer beside the vibrator (pose 4)
\end{itemize}

\begin{table*}
  \centering
  \begin{tabular}{l r r r r }
    No.
    & {\small{\textbf{Pose 1}}} 
    & {\small{\textbf{Pose 2}}}
    & {\small{\textbf{Pose 3}}} 
    & {\small{\textbf{Pose 4}}} \\
   1 & acc0\_04\_24\_00\_04\_56 & acc0\_04\_24\_00\_15\_16 & acc0\_04\_24\_00\_32\_31 & acc0\_04\_24\_00\_48\_49 \\
   2 & acc0\_04\_24\_00\_07\_20 & acc0\_04\_24\_00\_16\_51 & acc0\_04\_24\_00\_34\_11 & acc0\_04\_24\_00\_50\_59 \\
   3 & acc0\_04\_24\_00\_09\_23 & acc0\_04\_24\_00\_25\_36 & acc0\_04\_24\_00\_35\_57 & acc0\_04\_24\_00\_52\_26 \\
   4 & acc0\_04\_24\_00\_11\_14 & acc0\_04\_24\_00\_27\_10 & acc0\_04\_24\_00\_41\_09 & acc0\_04\_24\_00\_54\_06 \\
   5 & acc0\_04\_24\_00\_13\_16 & acc0\_04\_24\_00\_28\_50 & acc0\_04\_24\_00\_43\_52 & acc0\_04\_24\_00\_55\_42\\
  \end{tabular}
  \caption{references for the linear sweep experiments}~\label{tab:sweep}
\end{table*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose}
  \caption{4 poses for accelerometers measurement: (a) accelerometer facing the vibrator; (b) accelerometer backing the vibrator; (c) the rod's bottom being vibrated; (d) accelerometer beside the vibrator.}
    ~\label{fig:pose}
\end{figure*}

Pose 1 is the most probable way during our real measurement. Pose 2 and 4 is to explore whether the direction of the acceleromoters make a difference. Pose 3 is to simulate the condition where the vibration input is coming from the bottom of the arm where the bone is most directly attached.

\subsubsection{Frequency analysis of measured data} 

In the csv files generated by the raspberry pi, the three numbers in each row (time step) indicate the acceleration in x, y, and z axis (as shown in the python code). To get the frequency, I have several ideas: I. Take acceleration as frequency itself to calculate the proportion: just treat the dimension with biggest vibration or take the norm-2 (geometric) of the three. II. Find the frequency by plotting out dynamics: take the acceleration as gradient and plot the vibrations. I finally decided to treat the biggest acceleration axis as the input. 

To rearrange the data files and plot them out, I coded a bash script to generate a MATLAB code and save all the matrices into a .mat file (see referenced code csv2mat\_baihan.sh). Then, to automate the process, I coded another bash script to generate another MATLAB code for analyzing and plotting the data (see referenced code analysis\_baihan.sh). Inside the code, I first select out the period during which the experiment is on.

From Figure \ref{fig:pose1_1}-\ref{fig:pose4_5}, we can see that accelerometer facing the vibrator (pose 1) or tapped on the bottom of the rod (pose 3) gave the most consistent results. I assume the acc0 measured the position where the hand is holding the smart phone and the acc1 measured the source of vibration. Thus, as shown in the figures, proportion of signal from acc0 over signal of acc1 gave clearer results on potential natural frequencies.

However, it is noted that the biggest amplitudes doesn't always occur at the same frequency in different poses. For pose 1, the peak seems to be within the range about 100 Hz. For pose 2, the peak seems to be within the range 300 Hz. For pose 3, the peak seems to be within the range 100~200 Hz. For pose 4, the peak seems to be within the range 100~200 or 300 Hz.


\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_1}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 1}
    ~\label{fig:pose1_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_2}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 2}
    ~\label{fig:pose1_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_3}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 3}
    ~\label{fig:pose1_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_4}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 4}
    ~\label{fig:pose1_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose1_5}
  \caption{accelerometer signals vs. frequency swept in pose 1 experiment 5}
    ~\label{fig:pose1_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_1}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 1}
    ~\label{fig:pose2_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_2}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 2}
    ~\label{fig:pose2_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_3}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 3}
    ~\label{fig:pose2_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_4}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 4}
    ~\label{fig:pose2_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose2_5}
  \caption{accelerometer signals vs. frequency swept in pose 2 experiment 5}
    ~\label{fig:pose2_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_1}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 1}
    ~\label{fig:pose3_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_2}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 2}
    ~\label{fig:pose3_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_3}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 3}
    ~\label{fig:pose3_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_4}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 4}
    ~\label{fig:pose3_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose3_5}
  \caption{accelerometer signals vs. frequency swept in pose 3 experiment 5}
    ~\label{fig:pose3_5}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_1}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 1}
    ~\label{fig:pose4_1}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_2}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 2}
    ~\label{fig:pose4_2}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_3}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 3}
    ~\label{fig:pose4_3}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_4}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 4}
    ~\label{fig:pose4_4}
\end{figure*}

\begin{figure*}
  \centering
  \includegraphics[width=1.95\columnwidth]{figures/pose4_5}
  \caption{accelerometer signals vs. frequency swept in pose 4 experiment 5}
    ~\label{fig:pose4_5}
\end{figure*}

\section{Codes}

\subsection{Original: csv2mat\_baihan.sh}\label{ss:csv2mat}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: csv to mat
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

folder=`pwd`
for f in `ls *csv`
do
    mname=${f//.csv/}
    cat $mname.csv | tr '\n' ';' > $mname.list 
    sed -i -e "s/^/${mname}=[/" $mname.list
    sed -i -e 's/$/];/' $mname.list
done

cat *list > ${folder//*\//}_analysis_baihan.m
echo "save('${folder//*\//}');" >> ${folder//*\//}_data_baihan.m
rm *.list*

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop -r "${folder//*\//}_data_baihan"
\end{lstlisting}

\subsection{Original: analysis\_baihan.sh}\label{ss:ana.sh}
\begin{lstlisting}
#!/bin/bash

# -*- coding: utf-8 -*-
# Code: analysis
# Author: Baihan Lin
# Date: Apr 2017
# Lab: UbiComp Lab

folder=`pwd`
mscript=${folder//*\//}_analysis_baihan.m
echo "% analysis.m for experiment ${folder//*\//} \n% Baihan Lin, Apr 2017\n" > $mscript

echo "clear all; close all;" >> $mscript
echo "\nload('${folder//*\//}.mat')\n" >> $mscript
echo "path=('$folder/out/');\nsystem(['mkdir ' path]);\n" >> $mscript

for f in `ls acc0*csv`
do
    acc0=${f//.csv/}
    acc1=${acc0/acc0/acc1}

	echo "%% -----$acc0 $acc1------\n" >> $mscript
    echo "n_$acc0 = max($acc0.');" >> $mscript
    echo "n_$acc1 = max($acc1.');\n" >> $mscript
    echo "n = int64(length($acc0) * 6 / 7);" >> $mscript
    echo "maxval=0;\nmaxindex=0;" >> $mscript
    echo "\nfor m = 1:length($acc0)-n\n
    s=sum(n_$acc0(m:m+n-1));\nif(s>maxval)\nmaxval = s;\nmaxindex = m;\nend\nend\n" >> $mscript
    echo "p01 = n_$acc0(maxindex:maxindex+n-1)
    ./n_$acc1(maxindex:maxindex+n-1);" >> $mscript
    echo "p10 = n_$acc1(maxindex:maxindex+n-1)
    ./n_$acc0(maxindex:maxindex+n-1);\n" >> $mscript

	echo "figure(1)\nset(gca,'FontSize',16)\n
    plot(linspace(0,1000,n),p01);" >> $mscript
	echo "ylabel('acc0/acc1');\nxlabel('frequency (Hz)');\ntitle('acc0${acc1//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc0$acc1.png');\nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(2)\nset(gca,'FontSize',16)\n
    plot(linspace(0,1000,n),p10);" >> $mscript
	echo "ylabel('acc1/acc0');\nxlabel('frequency (Hz)');\ntitle('acc1${acc0//_/\\_}');" >> $mscript
	echo "filename = strcat(path, 'pacc1$acc0.png');\nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(3)\nset(gca,'FontSize',16)" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc0(maxindex:maxindex+n-1,1)); hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc0(maxindex:maxindex+n-1,2)); hold on" >> $mscript
	echo "plot(linspace(0,1000,n),$acc0(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');\nxlabel('frequency (Hz)');" >> $mscript
	echo "title('${acc0//_/\\_}');\nfilename = strcat(path, '$acc0.png');\nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "figure(4)\nset(gca,'FontSize',16);" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc1(maxindex:maxindex+n-1,1)); hold on" >> $mscript
	echo "plot(linspace(0,1000,n),
    $acc1(maxindex:maxindex+n-1,2)); hold on" >> $mscript
	echo "plot(linspace(0,1000,n),$acc1(maxindex:maxindex+n-1,3));" >> $mscript
	echo "ylabel('acceleration');\nxlabel('frequency (Hz)');" >> $mscript
	echo "title('${acc1//_/\\_}');\nfilename = strcat(path, '$acc1.png');\nsaveas(gcf, filename,'png');\n" >> $mscript

	echo "close(figure(1));close(figure(2));
    close(figure(3));close(figure(4));\n" >> $mscript

done

/Applications/Work/MATLAB_R2015b.app/bin/matlab -nodesktop -r "$mscript"
\end{lstlisting}

\subsection{Original: apr21\_analysis\_baihan.m}\label{ss:ana.m}
\begin{lstlisting}
% analysis.m for experiment apr21 
% Baihan Lin, Apr 2017

clear all; close all;

load('apr21.mat')

path=('/Users/DoerLBH/Dropbox/git/UbiComp_OsteoApp_FEA/
raspberry_pi/osteoapp/apr21/out/');
system(['mkdir ' path]);

%% -----acc0_04_24_00_04_56 acc1_04_24_00_04_56------

n_acc0_04_24_00_04_56 = max(acc0_04_24_00_04_56.');
n_acc1_04_24_00_04_56 = max(acc1_04_24_00_04_56.');

n = int64(length(acc0_04_24_00_04_56) * 6 / 7);
maxval=0;
maxindex=0;

for m = 1:length(acc0_04_24_00_04_56)-n
s=sum(n_acc0_04_24_00_04_56(m:m+n-1));
if(s>maxval)
maxval = s;
maxindex = m;
end
end

p01 = n_acc0_04_24_00_04_56(maxindex:maxindex+n-1)
./n_acc1_04_24_00_04_56(maxindex:maxindex+n-1);
p10 = n_acc1_04_24_00_04_56(maxindex:maxindex+n-1)
./n_acc0_04_24_00_04_56(maxindex:maxindex+n-1);

figure(1)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),p01);
ylabel('acc0/acc1');
xlabel('frequency (Hz)');
title('acc0acc1\_04\_24\_00\_04\_56');
filename = strcat(path, 'pacc0acc1_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(2)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),p10);
ylabel('acc1/acc0');
xlabel('frequency (Hz)');
title('acc1acc0\_04\_24\_00\_04\_56');
filename = strcat(path, 'pacc1acc0_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(3)
set(gca,'FontSize',16)
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,1)); hold on
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,2)); hold on
plot(linspace(0,1000,n),
acc0_04_24_00_04_56(maxindex:maxindex+n-1,3));
ylabel('acceleration');
xlabel('frequency (Hz)');
title('acc0\_04\_24\_00\_04\_56');
filename = strcat(path, 'acc0_04_24_00_04_56.png');
saveas(gcf, filename,'png');

figure(4)
set(gca,'FontSize',16);
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,1)); hold on
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,2)); hold on
plot(linspace(0,1000,n),
acc1_04_24_00_04_56(maxindex:maxindex+n-1,3));
ylabel('acceleration');
xlabel('frequency (Hz)');
title('acc1\_04\_24\_00\_04\_56');
filename = strcat(path, 'acc1_04_24_00_04_56.png');
saveas(gcf, filename,'png');

close(figure(1));close(figure(2));
 close(figure(3));close(figure(4));
\end{lstlisting}
... (other sample similar to this)

\subsection{Referenced: daisychain\_baihan.py}\label{ss:daisy}
\begin{lstlisting}
#!/usr/bin/python
# -*- coding: utf-8 -*-
# Example on how to read the ADXL345 accelerometer.
# Kim H. Rasmussen, 2014
# modified by Baihan Lin, 2017

import time
import spidev
import math
#import sys, select, os
import RPi.GPIO as GPIO
#import spi
import sys, select, os
import cPickle as pickle

time_run = 70
folder = "apr21"

counter0 = 0
counter1 = 0

GPIO.setmode(GPIO.BOARD)
GPIO.setup(22, GPIO.IN, pull_up_down=GPIO.PUD_UP)
#GPIO.setup(18, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# SETUP SPIs
spi1 = spidev.SpiDev()
spi1.open(0,1)

spi0 = spidev.SpiDev()
spi0.open(0,0)

def setup_spi(spi) :
    spi.mode = 3 # <-- make sure to set mode AFTER open
    spi.max_speed_hz = 5000000 # 3.9MHz < 5MHz (highest value for adxl345), 3.9MHz is equivalent to clock divisor of 64

setup_spi(spi1)
setup_spi(spi0)

# Read the Device ID (should be xE5)
# xfer transfers varying control select, but xfer2 cs will be held active
id = spi1.xfer2([128,0])
print 'Device ID (Should be 0xe5):\n'+str(hex(id[1])) + '\n'
id = spi0.xfer2([128,0])
print 'Device ID (Should be 0xe5):\n'+str(hex(id[1])) + '\n'

# open file to write data to
fname = time.strftime("%m_%d_%H_%M_%S", time.gmtime())
fname0 = folder + "/acc0_" + fname + ".pkl"
fname1 = folder + "/acc1_" + fname + ".pkl"
#print fname
f0 = open(folder + "/acc0_" + fname + ".pkl", "wb")
f1 = open(folder + "/acc1_" + fname + ".pkl", "wb")
#f0_string = "x_acc\ty_acc\tz_acc\n"
#f1_string = "x_acc\ty_acc\tz_acc\n"
f0_list = []
f1_list = []

# Initialize the ADXL345
def initadxl345(spi):
    # Enter power saving state
    spi.xfer2([45, 0]) # [0x2d, 0x00]

    # Set data rate to 3200 hz (rate code 0x0f) and not low power
    spi.xfer2([44, 15]) # [0x2c, 0x0f]

    # I didnt enable full range (sets number of bits) and set range to +/- 2g 
    # also sets to 4-wire spi
    #spi.xfer2([49, 0]) # [0x31, 0x00]
    #spi.xfer2([49, 0]) # [0x31, 0x00]
    #spi.xfer2([49, 10]) # [0x31, 0x00]
    spi.xfer2([49, 11]) # [0x31, 0b00001011] which means +-16g and full resolution
    

    #should probably set all to zero:
    #FIFO_CTL
    spi.xfer2([56, 0]) # 0x38, 0x00
    #ACT_INACT_CTL -- "If all axes are excluded, the function is disabled" d6, d5, d4
    spi.xfer2([39, 0]) # 0x27, 0x00
    #TAP_AXES
    spi.xfer2([42, 0]) # 0x2a, 0x00

    # set all offsets to 0
    spi.xfer2([30,0])
    spi.xfer2([31,0])
    spi.xfer2([32,0])

    # set DATA_READY interrupt in INT_ENABLE, automatically set to active-high
    spi.xfer2([46, 128]) # [0x2e, 0x80]
    # set INT_MAP to enable interrupts on int1 by setting the 0x80 bit to 0
    spi.xfer2([47, 0]) # [0x2f, 0x0]

    # Enable measurement
    spi.xfer2([45, 8]) # [0x2d, 0x08]

# Read the ADXL x-y-z axia
def readadxl345(spi):
    rx = spi.xfer2([242,0,0,0,0,0,0]) # 0xf2
    #print rx

    out = [rx[1] | (rx[2] << 8),rx[3] | (rx[4] << 8),rx[5] | (rx[6] << 8)]
    # Format x-axis
    if (out[0] & (1<<15)):
        out[0] = out[0] - (1<<16)
    #out[0] = out[0] * 9.82 / 256
    # Format y-axis
    if (out[1] & (1<<15)):
        out[1] = out[1] - (1<<16)
    #out[1] = out[1] * 9.82 / 256
    # Format z-axis
    if (out[2] & (1<<15)):
        out[2] = out[2] - (1<<16)
    #out[2] = out[2] * 9.82 / 256
    #print out

    return out

def read_save0(channel):
    #read_save(spi0, f0_string)
    #global f0_string
    global counter0
    axia = readadxl345(spi0)
    counter0 += 1
    pickle.dump(axia, f0)

    axia = readadxl345(spi1)
    pickle.dump(axia, f1)

#def read_save1(channel):
    #read_save(spi1, f1_string)

#def read_save(spi, f_string):
#    axia = readadxl345(spi)
#    f_string = f_string + str(axia[0]).zfill(5) + "\t" + str(axia[1]).zfill(5) + "\t" + str(axia[2]).zfill(5) + "\n"

# Initialize the ADXL345 accelerometer
initadxl345(spi1)
initadxl345(spi0)

timeout = time.time() + time_run

# Create callback for interrupt (Read the ADXL345)
#GPIO.add_event_detect(18, GPIO.RISING, callback=read_save1)
GPIO.add_event_detect(22, GPIO.RISING, callback=read_save0) 

# read once to fix interrupt... (clears the current interrupt)
#rx = readadxl345(spi1)
rx = readadxl345(spi0)

time.sleep(time_run)

GPIO.cleanup()
time.sleep(1)
f0.close()
f1.close()

print(counter0/time_run)
#print(counter1/time_run)

f0_csv = open(folder + "/acc0_" + fname + ".csv", "w")
pickledtext = []
file0 = open(fname0, "rb")
l = []
while 1:
    try :
        line = pickle.load(file0)
        #print line
        l.append("\t".join(str(x) for x in line))
    except EOFError:
        break
f0_csv.write("\n".join(l))
f0_csv.close()
#f0.close()

f1_csv = open(folder + "/acc1_" + fname + ".csv", "w")
pickledtext = []
file1 = open(fname1, "rb")
l = []
while 1:
    try :
        line = pickle.load(file1)
        #print line
        l.append("\t".join(str(x) for x in line))
    except EOFError:
        break
f1_csv.write("\n".join(l))
f1_csv.close()
\end{lstlisting}

\section{Acknowledgments}

Thank Prof. Shwetak Patel for the opportunity to join this exciting lab and work on this meaningful project. Thank Morelle and Josh for the patient guidance and faith in me through the project. Thank UbiComp Lab members for helpful advice and support. Thank Hongtao Wu, Yuxin Fu, Che Yi, and Ziwen Guo for helpful discussion in mechanical engineering and material science. Thank University of Washington for the wonderful platforms and resources in electrical engineering, mechanical engineering and computer science. 

\balance{}


% REFERENCES FORMAT
% References must be the same font size as other body text.
\bibliographystyle{SIGCHI-Reference-Format}
\bibliography{sample}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
